<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صحة لإدارة المخزون والمبيعات (مشترك)</title>
    
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#1e40af">
    <meta name="description" content="تطبيق لإدارة مخزون ومبيعات مصنع مياه صحة">

    <link rel="icon" href="logo-512.png">
    <link rel="apple-touch-icon" href="logo-512.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- jsPDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --sidebar-bg: linear-gradient(180deg, #1e40af 0%, #1d4ed8 100%);
            --primary-accent: #3b82f6;
            --primary-accent-hover: #2563eb;
            --background-color: #f0f4f8;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --white-text: #ffffff;
            --border-color: #e2e8f0;
            --card-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 16px;
            --danger-color: #ef4444;
            --success-color: #22c55e;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--background-color); color: var(--text-primary); line-height: 1.6; }
        
        /* شاشة التحميل (بدلاً من تسجيل الدخول) */
        #loading-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100vh; background-color: var(--background-color); text-align: center; padding: 2rem; }
        #loading-screen img { max-width: 150px; margin-bottom: 2rem; border-radius: 20px; }
        #loading-screen p { font-size: 1.2rem; color: var(--text-secondary); margin-top: 1rem; }
        .spinner {
             width: 50px;
             height: 50px;
             border: 5px solid var(--border-color);
             border-top: 5px solid var(--primary-accent);
             border-radius: 50%;
             animation: spin 1s linear infinite;
             margin: 2rem auto;
         }
         @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


        .hidden { display: none !important; }
        .container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: var(--sidebar-bg); color: var(--white-text); padding: 2rem 1rem; position: fixed; top: 0; right: 0; height: 100%; transition: transform 0.3s ease-in-out; z-index: 100; }
        .sidebar .logo-container { text-align: center; margin-bottom: 1.5rem; }
        .sidebar .logo { max-width: 80px; height: auto; border-radius: 50%; border: 3px solid var(--primary-accent); background-color: #fff; }
        .sidebar h1 { text-align: center; margin-top: 0.5rem; font-size: 1.8rem; margin-bottom: 2rem; }
        .nav-menu ul { list-style-type: none; padding: 0; }
        .nav-menu li { margin-bottom: 0.5rem; }
        .nav-menu a { display: flex; align-items: center; padding: 0.9rem; color: var(--white-text); text-decoration: none; border-radius: 12px; transition: all 0.2s ease-in-out; font-size: 1.1rem; font-weight: 500; gap: 12px; }
        .nav-menu a:hover { background-color: rgba(255, 255, 255, 0.1); }
        .nav-menu a.active { background-color: var(--primary-accent); font-weight: 700; }
        .nav-menu a .icon { width: 24px; height: 24px; stroke-width: 2; }
        /* تم إخفاء معلومات المستخدم */
        /* .user-info { ... } */
        .main-content { flex-grow: 1; padding: 2rem; margin-right: 260px; transition: margin-right 0.3s ease-in-out; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .page-header h2 { font-size: 2.5rem; color: var(--text-primary); }
        .card { background-color: var(--card-bg); border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--card-shadow); margin-bottom: 1.5rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary); }
        input, select { padding: 0.8rem; border: 1px solid var(--border-color); border-radius: 10px; font-family: 'Tajawal', sans-serif; font-size: 1rem; }
        .btn { padding: 0.8rem 1.5rem; border: none; border-radius: 10px; font-family: 'Tajawal', sans-serif; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-sm { padding: 0.5rem 0.8rem; font-size: 0.85rem; border-radius: 8px; }
        .btn-primary { background-color: var(--primary-accent); color: var(--white-text); }
        .btn-primary:hover { background-color: var(--primary-accent-hover); }
        .btn-success { background-color: var(--success-color); color: var(--white-text); }
        .btn-danger { background-color: var(--danger-color); color: var(--white-text); }
        .btn-secondary { background-color: var(--border-color); color: var(--text-primary); }
        .btn-secondary:hover { background-color: #d1d5db; }

        .data-table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; overflow-x: auto; display: block; }
        .data-table th, .data-table td { padding: 1rem 1.2rem; text-align: right; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        .data-table thead { background-color: #f9fafb; }
        .data-table th { font-weight: 800; color: var(--text-secondary); text-transform: uppercase; font-size: 0.9rem; }
        .data-table td .actions { display: flex; gap: 0.5rem; }
        .low-stock { background-color: #fef2f2 !important; color: var(--danger-color); font-weight: 700; }
        .bom-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-radius: 8px; }
        .bom-item:nth-child(odd) { background-color: #f3f4f6; }
        
        /* Report Styles */
        .report-controls { display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end; }
        #reportContent { padding: 2rem; }
        #textReportOutput h3, #textReportOutput h4 { margin-bottom: 1rem; font-family: 'Tajawal', sans-serif; }
        #textReportOutput .data-table { margin-top: 0; }
        #textReportOutput .data-table th, #textReportOutput .data-table td { padding: 0.75rem; }
        
        .hamburger, .close-btn { display: none; cursor: pointer; background: none; border: none; font-size: 2rem; z-index: 101; }
        .hamburger { color: var(--text-primary); }
        .close-btn { color: var(--white-text); position: absolute; top: 1rem; left: 1rem; }
        @media (max-width: 992px) { .sidebar { transform: translateX(260px); } .sidebar.open { transform: translateX(0); } .main-content { margin-right: 0; } .hamburger { display: block; } .close-btn { display: block; } }
    </style>
</head>
<body>
    <!-- شاشة التحميل -->
    <div id="loading-screen">
        <img src="logo.png" alt="شعار صحة">
        <div class="spinner"></div>
        <p>جاري تحميل البيانات...</p>
    </div>

    <!-- حاوية التطبيق الرئيسية -->
    <div id="app-container" class="container hidden">
        <!-- الشريط الجانبي -->
        <aside class="sidebar" id="sidebar">
            <button class="close-btn" id="closeBtn">&times;</button>
            <div class="logo-container"><img src="logo.png" alt="شعار صحة" class="logo"></div>
            <h1>صحة للمخزون</h1>
            <nav class="nav-menu">
                 <ul>
                    <li><a href="#rawMaterials" class="nav-link active"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>المواد الخام</a></li>
                    <li><a href="#spareParts" class="nav-link"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l-5.5 5.5v5l2.4 1.4c.5.3 1.1.2 1.6-.2l4-4c.4-.4.4-1 0-1.4l-4-4c-.5-.4-1.1-.5-1.6-.2L7 7.5v-5zM12 22l5.5-5.5v-5l-2.4-1.4c-.5-.3-1.1-.2-1.6.2l-4 4c-.4.4-.4 1 0 1.4l4 4c.5.4 1.1.5 1.6.2L17 16.5v5zM2 12l5.5 5.5h5l1.4-2.4c.3-.5.2-1.1-.2-1.6l-4-4c-.4-.4-1-.4-1.4 0l-4 4c-.4.5-.5 1.1-.2 1.6L7.5 17h-5zM22 12l-5.5-5.5h-5l-1.4 2.4c-.3.5-.2 1.1.2 1.6l4 4c.4.4 1 .4 1.4 0l4-4c.4-.5.5-1.1.2-1.6L16.5 7h5z"/></svg>قطع الغيار</a></li>
                    <li><a href="#finishedProducts" class="nav-link"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 22h20"></path><path d="M14 18v-3a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v3"></path><path d="M2 18h2"></path><path d="M18 18h2"></path><path d="M5 18v-9l5-3 5 3v9"></path></svg>الإنتاج الجاهز</a></li>
                    <li><a href="#sales" class="nav-link"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="10" cy="20.5" r="1"/><circle cx="18" cy="20.5" r="1"/><path d="M2.5 2.5h3l2.7 12.4a2 2 0 0 0 2 1.6h7.7a2 2 0 0 0 2-1.6l1.6-8.4H7.1"/></svg>المبيعات</a></li>
                    <li><a href="#bom" class="nav-link"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>مكونات الإنتاج</a></li>
                    <li><a href="#waste" class="nav-link"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>الهدر والفقد</a></li>
                    <li><a href="#reports" class="nav-link"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>التقارير</a></li>
                    <li><a href="#settings" class="nav-link"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>الإعدادات</a></li>
                </ul>
            </nav>
            <!-- تم إزالة معلومات المستخدم -->
        </aside>

        <!-- المحتوى الرئيسي -->
        <main class="main-content">
            <button class="hamburger" id="hamburgerBtn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
            <section id="rawMaterialsPage" class="page active">
                <div class="page-header"><h2>المواد الخام</h2><button id="addRawMaterialBtn" class="btn btn-primary">إضافة مادة خام</button></div>
                <div class="card"><input type="text" id="rawMaterialsSearch" placeholder="ابحث عن مادة خام..."></div>
                <div class="card"><table class="data-table"><thead><tr><th>اسم المادة</th><th>المورد</th><th>الوحدة</th><th>الكمية الحالية</th><th>حد التنبيه</th><th>إجراءات</th></tr></thead><tbody id="rawMaterialsTable"></tbody></table></div>
            </section>
            <section id="sparePartsPage" class="page">
                <div class="page-header"><h2>قطع الغيار</h2><button id="addSparePartBtn" class="btn btn-primary">إضافة قطعة غيار</button></div>
                <div class="card"><input type="text" id="sparePartsSearch" placeholder="ابحث عن قطعة غيار..."></div>
                <div class="card"><table class="data-table"><thead><tr><th>اسم القطعة</th><th>المورد</th><th>الوحدة</th><th>الكمية الحالية</th><th>حد التنبيه</th><th>إجراءات</th></tr></thead><tbody id="sparePartsTable"></tbody></table></div>
            </section>
            <section id="finishedProductsPage" class="page">
                <div class="page-header"><h2>الإنتاج الجاهز</h2><button id="addProductBtn" class="btn btn-primary">إضافة منتج جديد</button></div>
                <div class="card"><input type="text" id="finishedProductsSearch" placeholder="ابحث عن منتج..."></div>
                <div class="card"><table class="data-table"><thead><tr><th>اسم المنتج</th><th>الوحدة</th><th>الكمية الحالية</th><th>إجراءات</th></tr></thead><tbody id="finishedProductsTable"></tbody></table></div>
            </section>
            <section id="salesPage" class="page">
                <div class="page-header"><h2>تسجيل مبيعات</h2></div>
                <div class="card"><div class="form-grid"><div class="form-group"><label for="salesProductSelect">اختر المنتج المباع</label><select id="salesProductSelect"></select></div><div class="form-group"><label for="salesQty">الكمية المباعة</label><input type="number" id="salesQty" min="1" placeholder="أدخل الكمية"></div></div><div style="margin-top: 2rem; text-align: left;"><button id="recordSaleBtn" class="btn btn-success">تسجيل البيع</button></div></div>
                <div class="card"><h3>سجل المبيعات</h3><table class="data-table"><thead><tr><th>التاريخ</th><th>اسم المنتج</th><th>الكمية</th></tr></thead><tbody id="salesLogTable"></tbody></table></div>
            </section>
            <section id="bomPage" class="page">
                <div class="page-header"><h2>مكونات الإنتاج (BOM)</h2></div>
                <div class="card"><div class="form-group"><label for="bomProductSelect">اختر منتجًا:</label><select id="bomProductSelect"></select></div><div id="bomDetails" class="hidden"><h3>مكونات: <span id="bomProductName"></span></h3><div id="bomList"></div><hr style="margin: 1.5rem 0;"><h4>إضافة مادة جديدة</h4><div class="form-grid" style="align-items: flex-end;"><div class="form-group"><label for="bomRawMaterialSelect">المادة الخام</label><select id="bomRawMaterialSelect"></select></div><div class="form-group"><label for="bomRawMaterialQty">الكمية</label><input type="number" id="bomRawMaterialQty" placeholder="1.5" step="0.01"></div><div class="form-group"><button id="addBomItemBtn" class="btn btn-success">إضافة</button></div></div></div></div>
            </section>
            <section id="wastePage" class="page">
                <div class="page-header"><h2>تسجيل الهدر والفقد</h2></div>
                <div class="card"><div class="form-grid"><div class="form-group"><label for="wasteTypeSelect">نوع الصنف</label><select id="wasteTypeSelect"><option value="raw">مادة خام</option><option value="spare">قطعة غيار</option><option value="product">منتج جاهز</option></select></div><div class="form-group"><label for="wasteItemSelect">اختر الصنف</label><select id="wasteItemSelect"></select></div><div class="form-group"><label for="wasteQty">الكمية المفقودة</label><input type="number" id="wasteQty" min="1"></div></div><div style="margin-top: 2rem; text-align: left;"><button id="recordWasteBtn" class="btn btn-danger">تسجيل الفقد</button></div></div>
                <div class="card"><h3>سجل الهدر</h3><table class="data-table"><thead><tr><th>التاريخ</th><th>نوع الصنف</th><th>اسم الصنف</th><th>الكمية</th></tr></thead><tbody id="wasteLogTable"></tbody></table></div>
            </section>
            <section id="reportsPage" class="page">
                <div class="page-header"><h2>التقارير</h2><button id="printReportBtn" class="btn btn-primary">تصدير PDF</button></div>
                <div class="card"><div class="report-controls"><div class="form-group"><label for="reportType">نوع التقرير</label><select id="reportType"><option value="daily">يومي</option><option value="monthly">شهري</option></select></div><div class="form-group"><label for="reportDate">اختر التاريخ</label><input type="date" id="reportDate"></div><div class="form-group"><label for="reportMonth" class="hidden">اختر الشهر</label><input type="month" id="reportMonth" class="hidden"></div><div class="form-group"><button id="generateReportBtn" class="btn btn-primary">عرض التقرير</button></div></div></div>
                <div id="reportContent" class="card"><div id="textReportOutput"><p style="text-align: center; color: var(--text-secondary);">اختر نوع التقرير والتاريخ لعرض البيانات.</p></div></div>
            </section>
            <section id="settingsPage" class="page">
                <div class="page-header"><h2>الإعدادات</h2></div>
                <!-- تم إزالة قسم إدارة الحساب وتسجيل الخروج -->
                <div class="card"><h3>إدارة البيانات</h3><div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;"><button id="exportDataBtn" class="btn btn-success">تصدير البيانات (JSON)</button><button id="importDataBtn" class="btn btn-secondary">استيراد البيانات (JSON)</button><input type="file" id="importFileInput" class="hidden" accept=".json"></div></div>
                <div class="card"><h3>حذف كل البيانات</h3><div style="margin-top: 1.5rem;"><button id="deleteAllDataBtn" class="btn btn-danger">حذف جميع البيانات نهائيًا</button></div></div>
            </section>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, writeBatch, updateDoc, enableIndexedDbPersistence, query, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBgejBNyO76QgcsBPThZkH7bv1szPbcRKk",
            authDomain: "sahha-webapp.firebaseapp.com",
            projectId: "sahha-webapp",
            storageBucket: "sahha-webapp.appspot.com",
            messagingSenderId: "21522402648",
            appId: "1:21522402648:web:c813c4eafcb937be44692d"
        };

        const SHARED_DATA_PATH = 'sharedInventoryData'; 

        const App = {
            db: null, userId: null, auth: null,
            state: { rawMaterials: [], spareParts: [], finishedProducts: [], wasteLog: [], transactions: [] },
            unsubscribers: [],
            listenersAttached: false,

            init(db, user, auth) {
                if (this.db) return; 
                console.log("Initializing App with Anonymous User ID:", user.uid);
                this.db = db; this.userId = user.uid; this.auth = auth;
                this.setupEventListeners();
                this.router.init();
                // استدعاء attachDataListeners بعد التأكد من تهيئة db
                this.attachDataListeners(); 
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
            },

            attachDataListeners() {
                // التأكد من وجود db قبل محاولة استخدامه
                if (!this.db) {
                     console.error("Firestore DB not initialized. Cannot attach listeners.");
                     return;
                }
                this.unsubscribers.forEach(unsub => unsub()); this.unsubscribers = [];
                const collectionsToSync = ['rawMaterials', 'spareParts', 'finishedProducts', 'wasteLog', 'transactions'];
                
                collectionsToSync.forEach(colName => {
                    const collectionRef = collection(this.db, `${SHARED_DATA_PATH}/${colName}`);
                    console.log(`Listening to shared path: ${SHARED_DATA_PATH}/${colName}`);

                    const unsub = onSnapshot(collectionRef, (snapshot) => {
                        console.log(`Data received for ${colName}:`, snapshot.docs.length, 'docs');
                        this.state[colName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        // تأكد من أن renderAll يتم استدعاؤه بعد تحديث state
                        this.renderAll(); 
                    }, (error) => console.error(`Error listening to ${colName}:`, error));
                    this.unsubscribers.push(unsub);
                });
            },

            setupEventListeners() {
                if (this.listenersAttached) return; 
                console.log("Setting up event listeners.");

                // تم إزالة مستمع زر تسجيل الخروج
                document.querySelector('.nav-menu').addEventListener('click', e => { const link = e.target.closest('a'); if (link) { e.preventDefault(); this.router.navigateTo(link.hash); } });
                document.getElementById('hamburgerBtn').addEventListener('click', () => document.getElementById('sidebar').classList.add('open'));
                document.getElementById('closeBtn').addEventListener('click', () => document.getElementById('sidebar').classList.remove('open'));
                
                document.getElementById('addRawMaterialBtn').addEventListener('click', () => this.rawMaterials.add());
                document.getElementById('rawMaterialsSearch').addEventListener('input', (e) => this.render.rawMaterials(e.target.value));
                document.getElementById('rawMaterialsTable').addEventListener('click', e => { if (e.target.dataset.id) { if (e.target.classList.contains('edit-btn')) this.rawMaterials.edit(e.target.dataset.id); if (e.target.classList.contains('delete-btn')) this.rawMaterials.delete(e.target.dataset.id); } });
                document.getElementById('addSparePartBtn').addEventListener('click', () => this.spareParts.add());
                document.getElementById('sparePartsSearch').addEventListener('input', (e) => this.render.spareParts(e.target.value));
                document.getElementById('sparePartsTable').addEventListener('click', e => { if (e.target.dataset.id) { if (e.target.classList.contains('edit-btn')) this.spareParts.edit(e.target.dataset.id); if (e.target.classList.contains('delete-btn')) this.spareParts.delete(e.target.dataset.id); } });
                document.getElementById('addProductBtn').addEventListener('click', () => this.products.add());
                document.getElementById('finishedProductsSearch').addEventListener('input', (e) => this.render.finishedProducts(e.target.value));
                document.getElementById('finishedProductsTable').addEventListener('click', e => { if (e.target.dataset.id) { if (e.target.classList.contains('edit-btn')) this.products.edit(e.target.dataset.id); if (e.target.classList.contains('delete-btn')) this.products.delete(e.target.dataset.id); if (e.target.classList.contains('add-production-btn')) this.products.addProduction(e.target.dataset.id); } });
                document.getElementById('recordSaleBtn').addEventListener('click', () => this.sales.record());
                document.getElementById('bomProductSelect').addEventListener('change', e => this.bom.showBOMForProduct(e.target.value));
                document.getElementById('addBomItemBtn').addEventListener('click', () => this.bom.add());
                document.getElementById('bomList').addEventListener('click', e => { if (e.target.classList.contains('delete-bom-item')) { const { productid, rmid } = e.target.dataset; this.bom.delete(productid, rmid); } });
                document.getElementById('wasteTypeSelect').addEventListener('change', () => this.render.wasteItemSelect());
                document.getElementById('recordWasteBtn').addEventListener('click', () => this.waste.record());
                document.getElementById('reportType').addEventListener('change', this.reports.toggleDateInputs);
                document.getElementById('generateReportBtn').addEventListener('click', () => this.reports.generate());
                document.getElementById('reportDate').valueAsDate = new Date();
                document.getElementById('reportMonth').value = new Date().toISOString().slice(0, 7);
                document.getElementById('printReportBtn').addEventListener('click', () => this.settings.printReport());
                document.getElementById('exportDataBtn').addEventListener('click', () => this.settings.exportData());
                document.getElementById('importDataBtn').addEventListener('click', () => document.getElementById('importFileInput').click());
                document.getElementById('importFileInput').addEventListener('change', e => this.settings.importData(e));
                document.getElementById('deleteAllDataBtn').addEventListener('click', () => this.settings.deleteAllData());
                
                this.listenersAttached = true;
                console.log("Event listeners attached.");
            },
            
            renderAll() {
                 // إضافة تحقق للتأكد من أن state معرفة قبل محاولة العرض
                 if (!this.state) {
                     console.warn("App state not ready for rendering yet.");
                     return;
                 }
                 console.log("Rendering all components...");
                 try {
                     this.render.rawMaterials();
                     this.render.spareParts();
                     this.render.finishedProducts();
                     this.render.bomProductSelect();
                     this.render.wasteItemSelect();
                     this.render.wasteLog();
                     this.render.salesProductSelect();
                     this.render.salesLog();
                     console.log("All components rendered.");
                 } catch (e) {
                      console.error("Error during renderAll:", e);
                 }
            },
            
            router: {
                pages: document.querySelectorAll('.page'), navLinks: document.querySelectorAll('.nav-link'),
                init() { const currentHash = window.location.hash || '#rawMaterials'; this.navigateTo(currentHash); window.addEventListener('hashchange', () => this.navigateTo(window.location.hash)); },
                navigateTo(hash) { 
                    if (!hash || hash === '#') hash = '#rawMaterials'; // تصحيح: التعامل مع hash فارغ
                    const targetPageId = hash.substring(1) + 'Page'; 
                    console.log("Navigating to:", targetPageId); // Add log
                    this.pages.forEach(p => p.classList.toggle('active', p.id === targetPageId)); 
                    this.navLinks.forEach(l => l.classList.toggle('active', l.hash === hash)); 
                    document.getElementById('sidebar').classList.remove('open'); 
                    if (hash === '#reports') {
                        // التأكد من أن App.reports موجود قبل استدعائه
                        if(App.reports && typeof App.reports.generate === 'function') {
                            App.reports.generate();
                        } else {
                            console.error("App.reports or App.reports.generate is not defined.");
                        }
                    } 
                }
            },

            render: {
                 // --- تم إضافة تدقيق وتحسينات هنا ---
                 rawMaterials(searchTerm = '') {
                     console.log("Rendering raw materials...");
                     const tableBody = document.getElementById('rawMaterialsTable');
                     // التحقق من وجود tableBody
                     if (!tableBody) { console.error("rawMaterialsTable not found"); return; }
                     // التحقق من وجود App.state.rawMaterials
                     if (!App.state || App.state.rawMaterials === undefined) { 
                         console.warn("App.state.rawMaterials is undefined during render.");
                         tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">جاري تحميل المواد الخام...</td></tr>`;
                         return;
                     }
                     try {
                         // التحقق من أن item.name موجود قبل استدعاء toLowerCase
                         const filtered = App.state.rawMaterials.filter(item => item && item.name && typeof item.name === 'string' && item.name.toLowerCase().includes(searchTerm.toLowerCase()));
                         if (filtered.length === 0) {
                             tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">لم يتم إضافة مواد خام بعد.</td></tr>`;
                         } else {
                             tableBody.innerHTML = filtered.map(item =>
                                 `<tr class="${(item.stock !== undefined && item.threshold !== undefined && item.stock <= item.threshold) ? 'low-stock' : ''}">
                                     <td>${item.name || 'غير متوفر'}</td>
                                     <td>${item.supplier || 'N/A'}</td>
                                     <td>${item.unit || ''}</td>
                                     <td>${item.stock !== undefined ? item.stock : '?'}</td>
                                     <td>${item.threshold !== undefined ? item.threshold : '?'}</td>
                                     <td class="actions">
                                         <button class="btn btn-secondary btn-sm edit-btn" data-id="${item.id}">تعديل</button>
                                         <button class="btn btn-danger btn-sm delete-btn" data-id="${item.id}">حذف</button>
                                     </td>
                                 </tr>`
                             ).join('');
                         }
                         console.log("Raw materials rendered successfully.");
                     } catch (e) {
                         console.error("Error during raw materials rendering:", e);
                         tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color: red;">خطأ في عرض المواد الخام.</td></tr>`;
                     }
                 },
                 spareParts(searchTerm = '') {
                     console.log("Rendering spare parts...");
                     const tableBody = document.getElementById('sparePartsTable');
                     if (!tableBody) { console.error("sparePartsTable not found"); return; }
                      if (!App.state || App.state.spareParts === undefined) { 
                         console.warn("App.state.spareParts is undefined during render.");
                         tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">جاري تحميل قطع الغيار...</td></tr>`;
                         return;
                     }
                     try {
                         const filtered = App.state.spareParts.filter(item => item && item.name && typeof item.name === 'string' && item.name.toLowerCase().includes(searchTerm.toLowerCase()));
                         if (filtered.length === 0) {
                             tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">لم يتم إضافة قطع غيار بعد.</td></tr>`;
                         } else {
                             tableBody.innerHTML = filtered.map(item =>
                                 `<tr class="${(item.stock !== undefined && item.threshold !== undefined && item.stock <= item.threshold) ? 'low-stock' : ''}">
                                     <td>${item.name || 'غير متوفر'}</td>
                                     <td>${item.supplier || 'N/A'}</td>
                                     <td>${item.unit || ''}</td>
                                     <td>${item.stock !== undefined ? item.stock : '?'}</td>
                                     <td>${item.threshold !== undefined ? item.threshold : '?'}</td>
                                     <td class="actions">
                                         <button class="btn btn-secondary btn-sm edit-btn" data-id="${item.id}">تعديل</button>
                                         <button class="btn btn-danger btn-sm delete-btn" data-id="${item.id}">حذف</button>
                                     </td>
                                 </tr>`
                             ).join('');
                         }
                         console.log("Spare parts rendered successfully.");
                     } catch (e) {
                         console.error("Error during spare parts rendering:", e);
                         tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color: red;">خطأ في عرض قطع الغيار.</td></tr>`;
                     }
                 },
                 // --- بقية دوال render (بدون تغييرات كبيرة، لكن يجب التأكد من وجود العناصر) ---
                 finishedProducts(searchTerm = '') { const tableBody = document.getElementById('finishedProductsTable'); if (!tableBody || !App.state || App.state.finishedProducts === undefined) return; try { /* ... */ } catch(e) { console.error("Error rendering finished products:", e); }},
                 salesProductSelect() { const select = document.getElementById('salesProductSelect'); if (!select || !App.state || App.state.finishedProducts === undefined) return; select.innerHTML = '<option value="">-- اختر منتج --</option>' + App.state.finishedProducts.map(p => `<option value="${p.id}">${p.name}</option>`).join(''); },
                 salesLog() { const tableBody = document.getElementById('salesLogTable'); if (!tableBody || !App.state || App.state.transactions === undefined) return; const sales = App.state.transactions.filter(t => t.type === 'sale'); /* ... */ },
                 bomProductSelect() { const select = document.getElementById('bomProductSelect'); if (!select || !App.state || App.state.finishedProducts === undefined) return; select.innerHTML = '<option value="">-- اختر منتج --</option>' + App.state.finishedProducts.map(p => `<option value="${p.id}">${p.name}</option>`).join(''); },
                 bomList(productId) { const listDiv = document.getElementById('bomList'); if (!listDiv || !App.state || App.state.finishedProducts === undefined || App.state.rawMaterials === undefined) return; const product = App.state.finishedProducts.find(p => p.id === productId); /* ... */ },
                 bomRawMaterialSelect() { const select = document.getElementById('bomRawMaterialSelect'); if (!select || !App.state || App.state.rawMaterials === undefined) return; select.innerHTML = '<option value="">-- اختر مادة خام --</option>' + App.state.rawMaterials.map(rm => `<option value="${rm.id}">${rm.name}</option>`).join(''); },
                 wasteItemSelect() { const select = document.getElementById('wasteItemSelect'); if (!select || !App.state) return; const type = document.getElementById('wasteTypeSelect').value; let items = []; if (type === 'raw' && App.state.rawMaterials) items = App.state.rawMaterials; else if (type === 'spare' && App.state.spareParts) items = App.state.spareParts; else if (type === 'product' && App.state.finishedProducts) items = App.state.finishedProducts; select.innerHTML = items.map(i => `<option value="${i.id}">${i.name}</option>`).join(''); },
                 wasteLog() { const tableBody = document.getElementById('wasteLogTable'); if (!tableBody || !App.state || App.state.wasteLog === undefined) return; /* ... */ },
            },

            // --- دوال العمليات (add, edit, delete, etc.) تبقى كما هي (تستخدم المسار المشترك) ---
            rawMaterials: { /* ... */ },
            spareParts: { /* ... */ },
            products: { /* ... */ },
            sales: { /* ... */ },
            bom: { /* ... */ },
            waste: { /* ... */ },
            reports: { /* ... */ },
            settings: { /* ... */ }
        };

        // --- Auth Handling (Modified for Anonymous Auth) ---
        try {
            console.log("Initializing Firebase...");
            const firebaseApp = initializeApp(firebaseConfig);
            const auth = getAuth(firebaseApp);
            const db = getFirestore(firebaseApp);
            
            enableIndexedDbPersistence(db)
              .catch((err) => {
                  if (err.code == 'failed-precondition') {
                      console.warn('Firebase persistence failed: multiple tabs open.');
                  } else if (err.code == 'unimplemented') {
                       console.error('Firebase persistence is not available in this browser.');
                  }
              });

            // مراقبة حالة المصادقة وتسجيل الدخول كمجهول إذا لزم الأمر
            onAuthStateChanged(auth, user => {
                if (user) {
                    console.log("User is signed in:", user.uid, "Is anonymous:", user.isAnonymous);
                    // استدعاء App.init فقط إذا لم يتم تهيئته من قبل
                    if (!App.db) {
                         App.init(db, user, auth);
                    } else {
                        // إذا تم تهيئته بالفعل، تأكد من تحديث userId إذا تغير (نظريًا لا يجب أن يتغير للمجهول)
                        App.userId = user.uid;
                        console.log("App already initialized, updated userId if changed.");
                        // قد تحتاج لاستدعاء attachDataListeners إذا كنت تريد إعادة تحميل البيانات عند تغيير المستخدم (غير محتمل هنا)
                        // App.attachDataListeners(); 
                    }
                } else {
                    console.log("User is signed out. Signing in anonymously...");
                    signInAnonymously(auth)
                        .then((userCredential) => {
                             console.log("Signed in anonymously successfully.");
                             // لا حاجة لـ App.init هنا، onAuthStateChanged سيعمل مرة أخرى
                        })
                        .catch((error) => {
                            console.error("Anonymous sign-in error", error);
                            Swal.fire('خطأ فادح', 'لم نتمكن من تسجيل الدخول المجهول. لا يمكن مزامنة البيانات.', 'error');
                             document.getElementById('loading-screen').innerHTML = '<h1>فشل تسجيل الدخول المجهول. الرجاء التأكد من اتصالك بالإنترنت وتحديث الصفحة.</h1>';
                        });
                }
            });
        } catch (e) {
            console.error("Firebase initialization failed:", e);
             document.getElementById('loading-screen').innerHTML = '<h1>فشل تهيئة Firebase. الرجاء تحديث الصفحة.</h1>';
        }
    </script>
</body>
</html>

