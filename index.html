<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>منظومة مخازن صحة — نسخة Firebase + إصلاح التقارير + قطع الغيار + BOM مرن</title>
  <style>
    :root{--brand:#0a6cff;--ink:#0f172a;--muted:#6b7280;--bg:#f6f7fb;--card:#ffffff;--line:#e5e7eb}
    *{box-sizing:border-box}body{margin:0;font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;z-index:10;background:#fffcc;border-bottom:1px solid var(--line);backdrop-filter:saturate(1.5) blur(6px)}
    .bar{display:flex;align-items:center;gap:10px;max-width:1200px;margin:0 auto;padding:10px 16px}
    .logo{font-weight:800;color:var(--brand)}
    nav{display:flex;flex-wrap:wrap;gap:6px;margin-inline-start:auto}
    nav button{border:1px solid var(--line);background:var(--card);padding:8px 12px;border-radius:12px;cursor:pointer}
    nav button.active{background:var(--brand);color:#fff;border-color:transparent}
    main{max-width:1200px;margin:18px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 4px 18px rgba(2,6,23,.04)}
    h2{margin:6px 0 12px 0}label{font-size:14px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:12px}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    table{width:100%;border-collapse:collapse}th,td{padding:10px;border-bottom:1px solid #f0f2f6;text-align:start}
    .btn{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:var(--card);padding:9px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
    .stack{display:flex;gap:8px;flex-wrap:wrap}.muted{color:var(--muted)}.hidden{display:none}
    @media (max-width:900px){.col-4,.col-6,.col-8{grid-column:span 12}}
    pre{white-space:pre-wrap;line-height:1.8}
  </style>

  <!-- Firebase SDKs (فعّل مفاتيحك من الإعدادات داخل التطبيق) -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
</head>
<body>
  <header>
    <div class="bar">
      <div class="logo">صـحـة • Saha Inventory</div>
      <nav id="nav">
        <button data-section="dashboard" class="active">الرئيسية</button>
        <button data-section="raw">الخامات</button>
        <button data-section="bom">BOM</button>
        <button data-section="production">إنتاج</button>
        <button data-section="reports">التقارير</button>
        <button data-section="spares">قطع الغيار</button>
        <button data-section="settings">الإعدادات</button>
      </nav>
      <div id="userBox" class="stack">
        <span id="userEmail" class="muted">غير مسجل</span>
        <button id="googleLogin" class="btn">تسجيل دخول Google</button>
        <button id="logoutBtn" class="btn hidden">خروج</button>
      </div>
    </div>
  </header>

  <main>
    <!-- الرئيسية -->
    <section id="dashboard" class="card">
      <h2>لوحة التحكم</h2>
      <p class="muted">نسخة معدّلة: إصلاح التقارير + قطع الغيار + BOM مرن + Google Sign-in.</p>
      <div class="row">
        <div class="col-4 card"><h3>الخامات</h3><div id="statsRaw"></div></div>
        <div class="col-4 card"><h3>الإنتاج</h3><div id="statsFinished"></div></div>
        <div class="col-4 card"><h3>قطع الغيار</h3><div id="statsSpares"></div></div>
      </div>
    </section>

    <!-- الخامات -->
    <section id="raw" class="card hidden">
      <div class="row">
        <div class="col-8">
          <h2>الخامات</h2>
          <table><thead>
            <tr><th>الصنف</th><th>الوحدة</th><th>المخزون</th><th>حد إعادة الطلب</th><th>تحويلات</th><th></th></tr>
          </thead><tbody id="rawTableBody"></tbody></table>
        </div>
        <div class="col-4">
          <h2>إضافة / تعديل خامة</h2>
          <div class="stack card">
            <label>الاسم<input id="rawName"></label>
            <label>الوحدة<select id="rawUnit"><option value="pcs">قطعة</option><option value="kg">كجم</option></select></label>
            <label>المخزون الابتدائي<input id="rawQty" type="number" step="0.0001"></label>
            <label>حد إعادة الطلب<input id="rawReorder" type="number" step="0.0001"></label>
            <div id="kgOptions" class="hidden">
              <label>عدد <b>العبوات لكل 1 كجم</b><input id="packsPerKg" type="number" step="0.0001" placeholder="مثال: 120 عبوة/كجم"></label>
            </div>
            <div class="stack"><button class="btn primary" id="saveRaw">حفظ</button><button class="btn" id="resetRaw">جديد</button></div>
          </div>
        </div>
      </div>
    </section>

    <!-- BOM -->
    <section id="bom" class="card hidden">
      <div class="row">
        <div class="col-8">
          <h2>قوائم المواد (BOM)</h2>
          <table><thead>
            <tr><th>المنتج</th><th>الخامة</th><th>نوع الاستهلاك</th><th>الكمية/الوحدة</th><th></th></tr>
          </thead><tbody id="bomTableBody"></tbody></table>
        </div>
        <div class="col-4">
          <h2>إضافة/تعديل BOM</h2>
          <div class="stack card">
            <label>اسم المنتج<input id="bomProduct"></label>
            <label>الخامة<select id="bomRaw"></select></label>
            <label>نوع الاستهلاك<select id="bomUsageType"><option value="pcs">عبوات/قطع</option><option value="grams">جرام</option></select></label>
            <label>الكمية لكل وحدة منتج<input id="bomQtyPerUnit" type="number" step="0.0001"></label>
            <div class="stack"><button class="btn primary" id="saveBom">حفظ</button><button class="btn" id="resetBom">جديد</button></div>
          </div>
        </div>
      </div>
    </section>

    <!-- الإنتاج -->
    <section id="production" class="card hidden">
      <div class="row">
        <div class="col-8">
          <h2>أوامر الإنتاج</h2>
          <table><thead>
            <tr><th>التاريخ</th><th>المنتج</th><th>الكمية</th><th>خصم الخامات</th></tr>
          </thead><tbody id="prodTableBody"></tbody></table>
        </div>
        <div class="col-4">
          <h2>تشغيل أمر إنتاج</h2>
          <div class="stack card">
            <label>المنتج<input id="prodProduct" placeholder="مثال: مياه 0.5 لتر"></label>
            <label>الكمية (وحدات جاهزة)<input id="prodQty" type="number" step="1"></label>
            <div class="stack"><button class="btn primary" id="runProd">تشغيل</button></div>
          </div>
        </div>
      </div>
    </section>

    <!-- التقارير -->
    <section id="reports" class="card hidden">
      <div class="row">
        <div class="col-8">
          <h2>التقارير</h2>
          <div class="stack">
            <select id="reportType"><option value="daily">يومي</option><option value="monthly">شهري</option></select>
            <input id="reportDate" type="date"><input id="reportMonth" type="month" class="hidden">
            <button class="btn" id="refreshReport">تحديث</button>
            <button class="btn" id="shareReport">مشاركة</button>
            <button class="btn" id="printReport">طباعة</button>
          </div>
          <pre id="reportText" class="card"></pre>
        </div>
        <div class="col-4">
          <h2>إعدادات التقرير</h2>
          <div class="card">
            <label>اسم الشركة<input id="companyName" placeholder="شركة صحة"></label>
            <label>الموقّع<input id="reportSigner" placeholder="مسؤول المخازن"></label>
            <label>ملاحظات عامة<textarea id="reportNotes" rows="6" placeholder="يُضاف ما يلزم من ملاحظات"></textarea></label>
            <button class="btn primary" id="saveFbCfg">حفظ إعدادات Firebase</button>
            <div class="row" style="margin-top:8px">
              <div class="col-6"><label>apiKey<input id="fb_apiKey"></label></div>
              <div class="col-6"><label>authDomain<input id="fb_authDomain"></label></div>
              <div class="col-6"><label>projectId<input id="fb_projectId"></label></div>
              <div class="col-6"><label>appId<input id="fb_appId"></label></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- قطع الغيار -->
    <section id="spares" class="card hidden">
      <div class="row">
        <div class="col-8">
          <h2>مخزون قطع الغيار</h2>
          <table><thead>
            <tr><th>الصنف</th><th>الآلة/القطاع</th><th>الكمية</th><th>حد إعادة الطلب</th><th></th></tr>
          </thead><tbody id="sparesTableBody"></tbody></table>
          <h3>سجل الاستخدام</h3>
          <table><thead>
            <tr><th>التاريخ</th><th>الصنف</th><th>الكمية</th><th>الآلة/القطاع</th><th>ملاحظات</th></tr>
          </thead><tbody id="sparesLogBody"></tbody></table>
        </div>
        <div class="col-4">
          <h2>إضافة/تعديل قطعة غيار</h2>
          <div class="stack card">
            <label>الاسم<input id="spName"></label>
            <label>الآلة/القطاع<input id="spMachine" placeholder="خط التعبئة / المضخة"></label>
            <label>المخزون<input id="spQty" type="number" step="1"></label>
            <label>حد إعادة الطلب<input id="spReorder" type="number" step="1"></label>
            <div class="stack"><button class="btn primary" id="saveSpare">حفظ</button><button class="btn" id="resetSpare">جديد</button></div>
          </div>
          <h2>خصم استخدام</h2>
          <div class="stack card">
            <label>الصنف<select id="spUseName"></select></label>
            <label>الكمية المستخدمة<input id="spUseQty" type="number" step="1"></label>
            <label>الآلة/القطاع<input id="spUseMachine"></label>
            <label>ملاحظات<textarea id="spUseNotes"></textarea></label>
            <button class="btn" id="applySpareUse">تسجيل الخصم</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script type="module" src="js/app.js"></script>
  <script>
    // تنقل الأقسام
    const $$ = s=>Array.from(document.querySelectorAll(s));
    $$('#nav button').forEach(btn=>btn.addEventListener('click',()=>{
      $$('#nav button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const sec = btn.dataset.section;
      document.querySelectorAll('main > section').forEach(s=>s.classList.add('hidden'));
      document.getElementById(sec).classList.remove('hidden');
      window.dispatchEvent(new CustomEvent('saha:render'));
    }));
  </script>
</body>
</html>
