<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صحة لإدارة المخزون والمبيعات (مشترك)</title>
    
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#1e40af">
    <meta name="description" content="تطبيق لإدارة مخزون ومبيعات مصنع مياه صحة">

    <link rel="icon" href="logo-512.png">
    <link rel="apple-touch-icon" href="logo-512.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- jsPDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- أكواد الـ CSS المدمجة -->
    <style>
        :root {
            --sidebar-bg: linear-gradient(180deg, #1e40af 0%, #1d4ed8 100%);
            --primary-accent: #3b82f6;
            --primary-accent-hover: #2563eb;
            --background-color: #f0f4f8;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --white-text: #ffffff;
            --border-color: #e2e8f0;
            --card-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 16px;
            --danger-color: #ef4444;
            --success-color: #22c55e;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        /* شاشة التحميل */
        #loading-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100vh; background-color: var(--background-color); text-align: center; padding: 2rem; }
        #loading-screen img { max-width: 150px; margin-bottom: 2rem; border-radius: 20px; }
        #loading-screen p { font-size: 1.2rem; color: var(--text-secondary); margin-top: 1rem; }
        .spinner {
             width: 50px;
             height: 50px;
             border: 5px solid var(--border-color);
             border-top: 5px solid var(--primary-accent);
             border-radius: 50%;
             animation: spin 1s linear infinite;
             margin: 2rem auto;
         }
         @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .hidden { display: none !important; }

        .container { display: flex; min-height: 100vh; }

        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            color: var(--white-text);
            padding: 2rem 1rem;
            position: fixed;
            top: 0;
            right: 0;
            height: 100%;
            transition: transform 0.3s ease-in-out;
            z-index: 100;
        }

        .sidebar .logo-container { text-align: center; margin-bottom: 1.5rem; }
        .sidebar .logo { max-width: 80px; height: auto; border-radius: 50%; border: 3px solid var(--primary-accent); background-color: #fff; }
        .sidebar h1 { text-align: center; margin-top: 0.5rem; font-size: 1.8rem; margin-bottom: 2rem; }

        .nav-menu ul { list-style-type: none; padding: 0; }
        .nav-menu li { margin-bottom: 0.5rem; }
        .nav-menu a { display: flex; align-items: center; padding: 0.9rem; color: var(--white-text); text-decoration: none; border-radius: 12px; transition: all 0.2s ease-in-out; font-size: 1.1rem; font-weight: 500; gap: 12px; }
        .nav-menu a:hover { background-color: rgba(255, 255, 255, 0.1); }
        .nav-menu a.active { background-color: var(--primary-accent); font-weight: 700; }
        .nav-menu a .icon { width: 24px; height: 24px; stroke-width: 2; }

        .main-content { flex-grow: 1; padding: 2rem; margin-right: 260px; transition: margin-right 0.3s ease-in-out; }

        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .page-header h2 { font-size: 2.5rem; color: var(--text-primary); }

        .card { background-color: var(--card-bg); border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--card-shadow); margin-bottom: 1.5rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
        .form-group { display: flex; flex-direction: column; }

        label { font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary); }
        input, select { padding: 0.8rem; border: 1px solid var(--border-color); border-radius: 10px; font-family: 'Tajawal', sans-serif; font-size: 1rem; }
        
        input:focus, select:focus { outline: none; border-color: var(--primary-accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }

        .btn { padding: 0.8rem 1.5rem; border: none; border-radius: 10px; font-family: 'Tajawal', sans-serif; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-sm { padding: 0.5rem 0.8rem; font-size: 0.85rem; border-radius: 8px; }
        .btn-primary { background-color: var(--primary-accent); color: var(--white-text); }
        .btn-primary:hover { background-color: var(--primary-accent-hover); }
        .btn-success { background-color: var(--success-color); color: var(--white-text); }
        .btn-danger { background-color: var(--danger-color); color: var(--white-text); }
        .btn-secondary { background-color: var(--border-color); color: var(--text-primary); }
        .btn-secondary:hover { background-color: #d1d5db; }

        .btn:active { transform: scale(0.97); }
        .btn:hover { filter: brightness(1.1); }
        .btn .icon { width: 20px; height: 20px; }


        .data-table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; /* تم حذف overflow-x: auto; display: block; لجعل التجاوب يعمل */ }
        .data-table th, .data-table td { padding: 1rem 1.2rem; text-align: right; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        .data-table thead { background-color: #f9fafb; }
        .data-table th { font-weight: 800; color: var(--text-secondary); text-transform: uppercase; font-size: 0.9rem; }
        
        .data-table tbody tr { transition: background-color 0.2s; }
        .data-table tbody tr:hover { background-color: #f3f4f6; }
        
        .data-table td .actions { display: flex; gap: 0.5rem; }
        .low-stock { background-color: #fef2f2 !important; color: var(--danger-color); font-weight: 700; }
        
        .low-stock::after { content: '⚠️'; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); }

        .bom-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-radius: 8px; }
        .bom-item:nth-child(odd) { background-color: #f3f4f6; }
        
        /* Report Styles */
        .report-controls { display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end; }
        #reportContent { padding: 2rem; }
        
        #textReportOutput { background-color: #f9fafb; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 2rem; }
        #textReportOutput h3, #textReportOutput h4 { margin-bottom: 1rem; font-family: 'Tajawal', sans-serif; }
        #textReportOutput h3 { color: var(--text-primary); border-bottom: 2px solid var(--primary-accent); padding-bottom: 0.5rem; }
        #textReportOutput .report-section { margin-bottom: 2rem; }
        #textReportOutput .report-item { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px dashed var(--border-color); }
        #textReportOutput .report-item:last-child { border-bottom: none; }
        #textReportOutput .report-item h4 { color: var(--text-secondary); }
        #textReportOutput .report-item p { margin: 0.25rem 0; }
        #textReportOutput .report-item strong { color: var(--text-primary); }
        /* الجداول داخل التقرير تحتاج أيضاً لـ overflow-x */
        #textReportOutput .data-table { margin-top: 0; display: block; overflow-x: auto; }
        #textReportOutput .data-table th, #textReportOutput .data-table td { padding: 0.75rem; }
        
        .hamburger, .close-btn { display: none; cursor: pointer; background: none; border: none; font-size: 2rem; z-index: 101; }
        .hamburger { color: var(--text-primary); }
        .close-btn { color: var(--white-text); position: absolute; top: 1rem; left: 1rem; }
        
        @media (max-width: 992px) { 
            .sidebar { transform: translateX(260px); } 
            .sidebar.open { transform: translateX(0); } 
            .main-content { margin-right: 0; } 
            .hamburger { display: block; } 
            .close-btn { display: block; } 
        }

        @media (max-width: 576px) {
            .page-header { flex-direction: column; align-items: flex-start; }
            .page-header h2 { font-size: 2rem; }
            .main-content { padding: 1rem; }
        }

        /* --- (((( هذا هو الكود المضاف للتجاوب مع الهاتف )))) --- */
        @media (max-width: 768px) {
            .data-table {
                box-shadow: none;
            }
            .data-table thead {
                display: none; /* إخفاء رأس الجدول */
            }
            .data-table tr {
                display: block; /* تحويل كل صف إلى بطاقة */
                margin-bottom: 1.5rem;
                border-radius: var(--border-radius);
                border: 1px solid var(--border-color);
                box-shadow: var(--card-shadow);
                background: var(--card-bg);
            }
            .data-table td {
                display: block; /* جعل الخلايا عمودية */
                text-align: left; /* محاذاة النص لليسار */
                padding: 0.75rem 1rem;
                padding-right: 50%; /* مساحة لاسم الحقل */
                position: relative;
                border-bottom: 1px solid var(--border-color);
                white-space: normal; /* السماح بالتفاف النص */
            }
            .data-table td:last-child {
                border-bottom: none;
            }
            /* إضافة اسم الحقل قبل القيمة */
            .data-table td:before {
                content: attr(data-label); /* جلب النص من data-label */
                position: absolute;
                top: 0;
                right: 0; /* تحديد مكان اسم الحقل */
                width: 45%; /* عرض اسم الحقل */
                padding: 0.75rem 1rem;
                text-align: right;
                font-weight: 700;
                color: var(--text-primary);
                white-space: nowrap;
            }
            /* تنسيق خاص لخلية الإجراءات (الأزرار) */
            .data-table td.actions {
                padding: 0.75rem 1rem;
                text-align: center; /* توسيط الأزرار */
            }
            .data-table td.actions:before {
                display: none; /* إخفاء اسم الحقل "إجراءات" */
            }
            .data-table td .actions {
                justify-content: center; /* توسيط الأزرار أفقياً */
                gap: 0.75rem;
                flex-wrap: wrap; /* السماح للأزرار بالالتفاف */
            }
            .data-table td .actions .btn {
                flex-grow: 1; /* جعل الأزرار تتمدد لملء المساحة */
                min-width: 100px;
            }
            /* إصلاح جداول التقرير على الموبايل */
            #textReportOutput .data-table {
                display: block;
                overflow-x: auto; /* الجداول في التقرير نجعلها قابلة للسحب أفقياً */
                border: none;
                box-shadow: none;
            }
            #textReportOutput .data-table tr {
                display: table-row; /* إرجاعها لوضعها الطبيعي */
                margin-bottom: 0;
                border: none;
                box-shadow: none;
            }
            #textReportOutput .data-table td {
                display: table-cell; /* إرجاعها لوضعها الطبيعي */
                text-align: right;
                padding: 0.75rem;
                padding-right: 0.75rem;
                position: static;
                border-bottom: 1px solid var(--border-color);
                white-space: nowrap;
            }
            #textReportOutput .data-table td:before {
                display: none; /* إخفاء الـ labels في التقرير */
            }
            #textReportOutput .data-table thead {
                display: table-header-group; /* إظهار رأس الجدول في التقرير */
            }
        }
        /* --- (((( نهاية الكود المضاف )))) --- */
    </style>
</head>
<body>
    <!-- شاشة التحميل -->
    <div id="loading-screen">
        <img src="logo.png" alt="شعار صحة">
        <div class="spinner"></div>
        <p>جاري تحميل البيانات...</p>
    </div>

    <!-- حاوية التطبيق الرئيسية -->
    <div id="app-container" class="container hidden">
        <!-- الشريط الجانبي -->
        <aside class="sidebar" id="sidebar">
            <button class="close-btn" id="closeBtn">&times;</button>
            <div class="logo-container"><img src="logo.png" alt="شعار صحة" class="logo"></div>
            <h1>صحة للمخزون</h1>
            <nav class="nav-menu">
                 <ul>
                    <li><a href="#rawMaterials" class="nav-link active"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>المواد الخام</a></li>
                    <li><a href="#spareParts" class="nav-link"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l-5.5 5.5v5l2.4 1.4c.5.3 1.1.2 1.6-.2l4-4c.4-.4.4-1 0-1.4l-4-4c-.5-.4-1.1-.5-1.6-.2L7 7.5v-5zM12 22l5.5-5.5v-5l-2.4-1.4c-.5-.3-1.1-.2-1.6.2l-4 4c-.4.4-.4 1 0 1.4l4 4c.5.4 1.1.5 1.6.2L17 16.5v5zM2 12l5.5 5.5h5l1.4-2.4c.3-.5.2-1.1-.2-1.6l-4-4c-.4-.4-1-.4-1.4 0l-4 4c-.4.5-.5 1.1-.2 1.6L7.5 17h-5zM22 12l-5.5-5.5h-5l-1.4 2.4c-.3.5-.2 1.1.2 1.6l4 4c.4.4 1 .4 1.4 0l4-4c.4-.5.5-1.1.2-1.6L16.5 7h5z"/></svg>قطع الغيار</a></li>
                    <li><a href="#finishedProducts" class="nav-link"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 22h20"></path><path d="M14 18v-3a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v3"></path><path d="M2 18h2"></path><path d="M18 18h2"></path><path d="M5 18v-9l5-3 5 3v9"></path></svg>الإنتاج الجاهز</a></li>
                    <li><a href="#sales" class="nav-link"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="10" cy="20.5" r="1"/><circle cx="18" cy="20.5" r="1"/><path d="M2.5 2.5h3l2.7 12.4a2 2 0 0 0 2 1.6h7.7a2 2 0 0 0 2-1.6l1.6-8.4H7.1"/></svg>المبيعات</a></li>
                    <li><a href="#bom" class="nav-link"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>مكونات الإنتاج</a></li>
                    <li><a href="#waste" class="nav-link"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>الهدر والفقد</a></li>
                    <li><a href="#reports" class="nav-link"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>التقارير</a></li>
                    <li><a href="#settings" class="nav-link"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>الإعدادات</a></li>
                </ul>
            </nav>
        </aside>

        <!-- المحتوى الرئيسي -->
        <main class="main-content">
            <button class="hamburger" id="hamburgerBtn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
            <section id="rawMaterialsPage" class="page active">
                <div class="page-header"><h2>المواد الخام</h2><button id="addRawMaterialBtn" class="btn btn-primary">إضافة مادة خام</button></div>
                <div class="card"><input type="text" id="rawMaterialsSearch" placeholder="ابحث عن مادة خام..."></div>
                <div class="card"><table class="data-table"><thead><tr><th>اسم المادة</th><th>المورد</th><th>الوحدة</th><th>الكمية الحالية</th><th>حد التنبيه</th><th>إجراءات</th></tr></thead><tbody id="rawMaterialsTable"></tbody></table></div>
            </section>
            <section id="sparePartsPage" class="page">
                <div class="page-header"><h2>قطع الغيار</h2><button id="addSparePartBtn" class="btn btn-primary">إضافة قطعة غيار</button></div>
                <div class="card"><input type="text" id="sparePartsSearch" placeholder="ابحث عن قطعة غيار..."></div>
                <div class="card"><table class="data-table"><thead><tr><th>اسم القطعة</th><th>المورد</th><th>الوحدة</th><th>الكمية الحالية</th><th>حد التنبيه</th><th>إجراءات</th></tr></thead><tbody id="sparePartsTable"></tbody></table></div>
            </section>
            <section id="finishedProductsPage" class="page">
                <div class="page-header"><h2>الإنتاج الجاهز</h2><button id="addProductBtn" class="btn btn-primary">إضافة منتج جديد</button></div>
                <div class="card"><input type="text" id="finishedProductsSearch" placeholder="ابحث عن منتج..."></div>
                <div class="card"><table class="data-table"><thead><tr><th>اسم المنتج</th><th>الوحدة</th><th>الكمية الحالية</th><th>إجراءات</th></tr></thead><tbody id="finishedProductsTable"></tbody></table></div>
            </section>
            <section id="salesPage" class="page">
                <div class="page-header"><h2>تسجيل مبيعات</h2></div>
                <div class="card"><div class="form-grid"><div class="form-group"><label for="salesProductSelect">اختر المنتج المباع</label><select id="salesProductSelect"></select></div><div class="form-group"><label for="salesQty">الكمية المباعة</label><input type="number" id="salesQty" min="1" placeholder="أدخل الكمية"></div></div><div style="margin-top: 2rem; text-align: left;"><button id="recordSaleBtn" class="btn btn-success">تسجيل البيع</button></div></div>
                <div class="card"><h3>سجل المبيعات</h3><table class="data-table"><thead><tr><th>التاريخ</th><th>اسم المنتج</th><th>الكمية</th></tr></thead><tbody id="salesLogTable"></tbody></table></div>
            </section>
            <section id="bomPage" class="page">
                <div class="page-header"><h2>مكونات الإنتاج (BOM)</h2></div>
                <div class="card"><div class="form-group"><label for="bomProductSelect">اختر منتجًا:</label><select id="bomProductSelect"></select></div><div id="bomDetails" class="hidden"><h3>مكونات: <span id="bomProductName"></span></h3><div id="bomList"></div><hr style="margin: 1.5rem 0;"><h4>إضافة مادة جديدة</h4><div class="form-grid" style="align-items: flex-end;"><div class="form-group"><label for="bomRawMaterialSelect">المادة الخام</label><select id="bomRawMaterialSelect"></select></div><div class="form-group"><label for="bomRawMaterialQty">الكمية</label><input type="number" id="bomRawMaterialQty" placeholder="1.5" step="0.01"></div><div class="form-group"><button id="addBomItemBtn" class="btn btn-success">إضافة</button></div></div></div></div>
            </section>
            <section id="wastePage" class="page">
                <div class="page-header"><h2>تسجيل الهدر والفقد</h2></div>
                <div class="card"><div class="form-grid"><div class="form-group"><label for="wasteTypeSelect">نوع الصنف</label><select id="wasteTypeSelect"><option value="raw">مادة خام</option><option value="spare">قطعة غيار</option><option value="product">منتج جاهز</option></select></div><div class="form-group"><label for="wasteItemSelect">اختر الصنف</label><select id="wasteItemSelect"></select></div><div class="form-group"><label for="wasteQty">الكمية المفقودة</label><input type="number" id="wasteQty" min="1"></div></div><div style="margin-top: 2rem; text-align: left;"><button id="recordWasteBtn" class="btn btn-danger">تسجيل الفقد</button></div></div>
                <div class="card"><h3>سجل الهدر</h3><table class="data-table"><thead><tr><th>التاريخ</th><th>نوع الصنف</th><th>اسم الصنف</th><th>الكمية</th></tr></thead><tbody id="wasteLogTable"></tbody></table></div>
            </section>
            <section id="reportsPage" class="page">
                <div class="page-header"><h2>التقارير</h2><button id="printReportBtn" class="btn btn-primary">تصدير PDF</button></div>
                <div class="card"><div class="report-controls"><div class="form-group"><label for="reportType">نوع التقرير</label><select id="reportType"><option value="daily">يومي</option><option value="monthly">شهري</option></select></div><div class="form-group"><label for="reportDate">اختر التاريخ</label><input type="date" id="reportDate"></div><div class="form-group"><label for="reportMonth" class="hidden">اختر الشهر</label><input type="month" id="reportMonth" class="hidden"></div><div class="form-group"><button id="generateReportBtn" class="btn btn-primary">عرض التقرير</button></div></div></div>
                <div id="reportContent" class="card"><div id="textReportOutput"><p style="text-align: center; color: var(--text-secondary);">اختر نوع التقرير والتاريخ لعرض البيانات.</p></div></div>
            </section>
            <section id="settingsPage" class="page">
                <div class="page-header"><h2>الإعدادات</h2></div>
                <!-- تم إزالة قسم إدارة الحساب وتسجيل الخروج -->
                <div class="card"><h3>إدارة البيانات</h3><div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;"><button id="exportDataBtn" class="btn btn-success">تصدير البيانات (JSON)</button><button id="importDataBtn" class="btn btn-secondary">استيراد البيانات (JSON)</button><input type="file" id="importFileInput" class="hidden" accept=".json"></div></div>
                <div class="card"><h3>حذف كل البيانات</h3><div style="margin-top: 1.5rem;"><button id="deleteAllDataBtn" class="btn btn-danger">حذف جميع البيانات نهائيًا</button></div></div>
            </section>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, writeBatch, updateDoc, enableIndexedDbPersistence, query, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- ملاحظة: تم استبدال بيانات الاعتماد بقيم افتراضية ---
        // --- يجب عليك استبدالها ببيانات الاعتماد الخاصة بك إذا كانت مختلفة عن تلك الموجودة في Canvas ---
        const firebaseConfig = (typeof __firebase_config !== 'undefined')
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyBgejBNyO76QgcsBPThZkH7bv1szPbcRKk", // استخدم بياناتك إذا لم تكن في Canvas
                authDomain: "sahha-webapp.firebaseapp.com",
                projectId: "sahha-webapp",
                storageBucket: "sahha-webapp.appspot.com",
                messagingSenderId: "21522402648",
                appId: "1:21522402648:web:c813c4eafcb937be44692d"
            };

        // --- تعديل: أسماء المجموعات المشتركة ---
        const SHARED_COLLECTIONS = {
            rawMaterials: 'shared_rawMaterials',
            spareParts: 'shared_spareParts',
            finishedProducts: 'shared_finishedProducts',
            wasteLog: 'shared_wasteLog',
            transactions: 'shared_transactions'
        };

        const App = {
            db: null, userId: null, auth: null,
            state: { rawMaterials: [], spareParts: [], finishedProducts: [], wasteLog: [], transactions: [] },
            unsubscribers: [],
            listenersAttached: false,

            init(db, user, auth) {
                if (this.db) return; 
                console.log("Initializing App with Anonymous User ID:", user.uid);
                this.db = db; this.userId = user.uid; this.auth = auth;
                this.setupEventListeners();
                this.router.init();
                this.attachDataListeners(); 
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
            },

            attachDataListeners() {
                if (!this.db) { console.error("Firestore DB not initialized. Cannot attach listeners."); return; }
                
                this.unsubscribers.forEach(unsub => unsub()); 
                this.unsubscribers = [];
                
                // استخدام الأسماء من SHARED_COLLECTIONS
                Object.keys(SHARED_COLLECTIONS).forEach(stateKey => {
                    const collectionName = SHARED_COLLECTIONS[stateKey];
                    const collectionRef = collection(this.db, collectionName); // المسار الصحيح الآن
                    console.log(`Listening to shared collection: ${collectionName}`);

                    const unsub = onSnapshot(collectionRef, (snapshot) => {
                        console.log(`Data received for ${collectionName}:`, snapshot.docs.length, 'docs');
                        // التأكد من تحديث المفتاح الصحيح في state
                        this.state[stateKey] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        this.renderAll(); 
                    }, (error) => console.error(`Error listening to ${collectionName}:`, error));
                    this.unsubscribers.push(unsub);
                });
            },

            setupEventListeners() {
                // ... (نفس الكود الخاص بـ event listeners بدون تغيير) ...
                if (this.listenersAttached) return; 
                console.log("Setting up event listeners.");
                document.querySelector('.nav-menu').addEventListener('click', e => { const link = e.target.closest('a'); if (link) { e.preventDefault(); this.router.navigateTo(link.hash); } });
                document.getElementById('hamburgerBtn').addEventListener('click', () => document.getElementById('sidebar').classList.add('open'));
                document.getElementById('closeBtn').addEventListener('click', () => document.getElementById('sidebar').classList.remove('open'));
                document.getElementById('addRawMaterialBtn').addEventListener('click', () => this.rawMaterials.add());
                document.getElementById('rawMaterialsSearch').addEventListener('input', (e) => this.render.rawMaterials(e.target.value));
                document.getElementById('rawMaterialsTable').addEventListener('click', e => { if (e.target.dataset.id) { if (e.target.classList.contains('edit-btn')) this.rawMaterials.edit(e.target.dataset.id); if (e.target.classList.contains('delete-btn')) this.rawMaterials.delete(e.target.dataset.id); } });
                document.getElementById('addSparePartBtn').addEventListener('click', () => this.spareParts.add());
                document.getElementById('sparePartsSearch').addEventListener('input', (e) => this.render.spareParts(e.target.value));
                document.getElementById('sparePartsTable').addEventListener('click', e => { if (e.target.dataset.id) { if (e.target.classList.contains('edit-btn')) this.spareParts.edit(e.target.dataset.id); if (e.target.classList.contains('delete-btn')) this.spareParts.delete(e.target.dataset.id); } });
                document.getElementById('addProductBtn').addEventListener('click', () => this.products.add());
                document.getElementById('finishedProductsSearch').addEventListener('input', (e) => this.render.finishedProducts(e.target.value));
                document.getElementById('finishedProductsTable').addEventListener('click', e => { if (e.target.dataset.id) { if (e.target.classList.contains('edit-btn')) this.products.edit(e.target.dataset.id); if (e.target.classList.contains('delete-btn')) this.products.delete(e.target.dataset.id); if (e.target.classList.contains('add-production-btn')) this.products.addProduction(e.target.dataset.id); } });
                document.getElementById('recordSaleBtn').addEventListener('click', () => this.sales.record());
                document.getElementById('bomProductSelect').addEventListener('change', e => this.bom.showBOMForProduct(e.target.value));
                document.getElementById('addBomItemBtn').addEventListener('click', () => this.bom.add());
                document.getElementById('bomList').addEventListener('click', e => { if (e.target.classList.contains('delete-bom-item')) { const { productid, rmid } = e.target.dataset; this.bom.delete(productid, rmid); } });
                document.getElementById('wasteTypeSelect').addEventListener('change', () => this.render.wasteItemSelect());
                document.getElementById('recordWasteBtn').addEventListener('click', () => this.waste.record());
                document.getElementById('reportType').addEventListener('change', this.reports.toggleDateInputs);
                document.getElementById('generateReportBtn').addEventListener('click', () => this.reports.generate());
                document.getElementById('reportDate').valueAsDate = new Date();
                document.getElementById('reportMonth').value = new Date().toISOString().slice(0, 7);
                document.getElementById('printReportBtn').addEventListener('click', () => this.settings.printReport());
                document.getElementById('exportDataBtn').addEventListener('click', () => this.settings.exportData());
                document.getElementById('importDataBtn').addEventListener('click', () => document.getElementById('importFileInput').click());
                document.getElementById('importFileInput').addEventListener('change', e => this.settings.importData(e));
                document.getElementById('deleteAllDataBtn').addEventListener('click', () => this.settings.deleteAllData());
                this.listenersAttached = true;
                console.log("Event listeners attached.");
            },
            
            renderAll() {
                 if (!this.state) { console.warn("App state not ready for rendering yet."); return; }
                 console.log("Rendering all components...");
                 try {
                     this.render.rawMaterials();
                     this.render.spareParts();
                     this.render.finishedProducts();
                     this.render.bomProductSelect();
                     this.render.wasteItemSelect();
                     this.render.wasteLog();
                     this.render.salesProductSelect();
                     this.render.salesLog();
                     console.log("All components rendered.");
                 } catch (e) { console.error("Error during renderAll:", e); }
            },
            
            router: { 
                pages: null, navLinks: null,
                init() { this.pages = document.querySelectorAll('.page'); this.navLinks = document.querySelectorAll('.nav-link'); const currentHash = window.location.hash || '#rawMaterials'; this.navigateTo(currentHash); window.addEventListener('hashchange', () => this.navigateTo(window.location.hash)); },
                navigateTo(hash) { if(!hash) hash = '#rawMaterials'; const targetPageId = hash.substring(1) + 'Page'; this.pages.forEach(page => page.classList.toggle('active', page.id === targetPageId)); this.navLinks.forEach(link => link.classList.toggle('active', link.hash === hash)); document.getElementById('sidebar').classList.remove('open'); }
            },

            // --- (((( هنا تم تعديل دوال الـ Render لإضافة data-label )))) ---
            render: {
                rawMaterials(searchTerm = '') { 
                    const tableBody = document.getElementById('rawMaterialsTable'); 
                    const filtered = App.state.rawMaterials.filter(item => item.name.toLowerCase().includes(searchTerm.toLowerCase())); 
                    tableBody.innerHTML = filtered.length === 0 ? `<tr><td colspan="6" style="text-align:center;">لم يتم إضافة مواد خام بعد.</td></tr>` 
                    : filtered.map(item => 
                        `<tr class="${item.stock <= item.threshold ? 'low-stock' : ''}">
                            <td data-label="اسم المادة">${item.name}</td>
                            <td data-label="المورد">${item.supplier || 'N/A'}</td>
                            <td data-label="الوحدة">${item.unit}</td>
                            <td data-label="الكمية الحالية">${item.stock}</td>
                            <td data-label="حد التنبيه">${item.threshold}</td>
                            <td class="actions">
                                <button class="btn btn-secondary btn-sm edit-btn" data-id="${item.id}">تعديل</button>
                                <button class="btn btn-danger btn-sm delete-btn" data-id="${item.id}">حذف</button>
                            </td>
                        </tr>`).join(''); 
                },
                spareParts(searchTerm = '') { 
                    const tableBody = document.getElementById('sparePartsTable'); 
                    const filtered = App.state.spareParts.filter(item => item.name.toLowerCase().includes(searchTerm.toLowerCase())); 
                    tableBody.innerHTML = filtered.length === 0 ? `<tr><td colspan="6" style="text-align:center;">لم يتم إضافة قطع غيار بعد.</td></tr>` 
                    : filtered.map(item => 
                        `<tr class="${item.stock <= item.threshold ? 'low-stock' : ''}">
                            <td data-label="اسم القطعة">${item.name}</td>
                            <td data-label="المورد">${item.supplier || 'N/A'}</td>
                            <td data-label="الوحدة">${item.unit}</td>
                            <td data-label="الكمية الحالية">${item.stock}</td>
                            <td data-label="حد التنبيه">${item.threshold}</td>
                            <td class="actions">
                                <button class="btn btn-secondary btn-sm edit-btn" data-id="${item.id}">تعديل</button>
                                <button class="btn btn-danger btn-sm delete-btn" data-id="${item.id}">حذف</button>
                            </td>
                        </tr>`).join(''); 
                },
                finishedProducts(searchTerm = '') { 
                    const tableBody = document.getElementById('finishedProductsTable'); 
                    const filtered = App.state.finishedProducts.filter(item => item.name.toLowerCase().includes(searchTerm.toLowerCase())); 
                    tableBody.innerHTML = filtered.length === 0 ? `<tr><td colspan="4" style="text-align:center;">لم يتم إضافة منتجات جاهزة بعد.</td></tr>` 
                    : filtered.map(item => 
                        `<tr>
                            <td data-label="اسم المنتج">${item.name}</td>
                            <td data-label="الوحدة">${item.unit}</td>
                            <td data-label="الكمية الحالية">${item.stock}</td>
                            <td class="actions">
                                <button class="btn btn-success btn-sm add-production-btn" data-id="${item.id}">إضافة إنتاج</button>
                                <button class="btn btn-secondary btn-sm edit-btn" data-id="${item.id}">تعديل</button>
                                <button class="btn btn-danger btn-sm delete-btn" data-id="${item.id}">حذف</button>
                            </td>
                        </tr>`).join(''); 
                },
                salesProductSelect() { const select = document.getElementById('salesProductSelect'); select.innerHTML = '<option value="">-- اختر منتج --</option>' + App.state.finishedProducts.map(p => `<option value="${p.id}">${p.name}</option>`).join(''); },
                salesLog() { 
                    const tableBody = document.getElementById('salesLogTable'); 
                    const salesTransactions = App.state.transactions.filter(t => t.type === 'sale').sort((a,b) => new Date(b.date) - new Date(a.date)); 
                    if (salesTransactions.length === 0) { tableBody.innerHTML = `<tr><td colspan="3" style="text-align:center;">لا يوجد سجلات مبيعات.</td></tr>`; return; } 
                    tableBody.innerHTML = salesTransactions.map(log => { 
                        const item = App.state.finishedProducts.find(i => i.id === log.itemId); 
                        return `<tr>
                                    <td data-label="التاريخ">${new Date(log.date).toLocaleString('ar-EG')}</td>
                                    <td data-label="اسم المنتج">${item ? item.name : 'منتج محذوف'}</td>
                                    <td data-label="الكمية">${log.quantity}</td>
                                </tr>`; 
                    }).join(''); 
                },
                bomProductSelect() { const select = document.getElementById('bomProductSelect'); select.innerHTML = '<option value="">-- اختر منتج --</option>' + App.state.finishedProducts.map(p => `<option value="${p.id}">${p.name}</option>`).join(''); },
                bomList(productId) { const product = App.state.finishedProducts.find(p => p.id === productId); const listDiv = document.getElementById('bomList'); if (!product || !product.bom || product.bom.length === 0) { listDiv.innerHTML = '<p>لا توجد مكونات لهذا المنتج.</p>'; return; } listDiv.innerHTML = product.bom.map(item => { const rawMaterial = App.state.rawMaterials.find(rm => rm.id === item.rawMaterialId); return `<div class="bom-item"><span><strong>${rawMaterial ? rawMaterial.name : 'مادة محذوفة'}</strong>: ${item.quantity} ${rawMaterial ? rawMaterial.unit : ''}</span><button class="btn btn-danger btn-sm delete-bom-item" data-productid="${productId}" data-rmid="${item.rawMaterialId}">&times;</button></div>`; }).join(''); },
                bomRawMaterialSelect() { const select = document.getElementById('bomRawMaterialSelect'); select.innerHTML = '<option value="">-- اختر مادة خام --</option>' + App.state.rawMaterials.map(rm => `<option value="${rm.id}">${rm.name}</option>`).join(''); },
                wasteItemSelect(type = 'raw') { const select = document.getElementById('wasteItemSelect'); let items = []; if(type === 'raw') items = App.state.rawMaterials; else if(type === 'spare') items = App.state.spareParts; else items = App.state.finishedProducts; select.innerHTML = '<option value="">-- اختر صنف --</option>' + items.map(i => `<option value="${i.id}">${i.name}</option>`).join(''); },
                wasteLog() { 
                    const tableBody = document.getElementById('wasteLogTable'); 
                    const wasteLogs = App.state.wasteLog.sort((a,b) => new Date(b.date) - new Date(a.date)); 
                    if(wasteLogs.length === 0) { tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">لا يوجد سجلات هدر.</td></tr>`; return; } 
                    tableBody.innerHTML = wasteLogs.map(log => { 
                        let item; let typeAr; 
                        if(log.type === 'raw') { item = App.state.rawMaterials.find(i => i.id === log.itemId); typeAr = 'مادة خام'; } 
                        else if(log.type === 'spare') { item = App.state.spareParts.find(i => i.id === log.itemId); typeAr = 'قطعة غيار'; } 
                        else { item = App.state.finishedProducts.find(i => i.id === log.itemId); typeAr = 'منتج جاهز'; } 
                        return `<tr>
                                    <td data-label="التاريخ">${new Date(log.date).toLocaleString('ar-EG')}</td>
                                    <td data-label="نوع الصنف">${typeAr}</td>
                                    <td data-label="اسم الصنف">${item ? item.name : 'صنف محذوف'}</td>
                                    <td data-label="الكمية">${log.quantity}</td>
                                </tr>`; 
                    }).join(''); 
                },
            },
            // --- (((( نهاية تعديل دوال الـ Render )))) ---

            rawMaterials: {
                async add() { const { value: formValues } = await Swal.fire({ title: 'إضافة مادة خام جديدة', html: `<input id="swal-name" class="swal2-input" placeholder="اسم المادة" required><input id="swal-supplier" class="swal2-input" placeholder="المورد (اختياري)"><input id="swal-unit" class="swal2-input" placeholder="وحدة القياس (مثال: قطعة, لتر)"><input id="swal-stock" type="number" class="swal2-input" placeholder="الكمية الأولية" value="0" min="0"><input id="swal-threshold" type="number" class="swal2-input" placeholder="حد التنبيه (الكمية الأدنى)" value="0" min="0">`, focusConfirm: false, confirmButtonText: 'إضافة', cancelButtonText: 'إلغاء', showCancelButton: true, preConfirm: () => { const name = document.getElementById('swal-name').value; if (!name) { Swal.showValidationMessage(`اسم المادة مطلوب`); return false; } return { name: name, supplier: document.getElementById('swal-supplier').value, unit: document.getElementById('swal-unit').value, stock: parseFloat(document.getElementById('swal-stock').value) || 0, threshold: parseFloat(document.getElementById('swal-threshold').value) || 0, } } }); if (formValues) { try { await addDoc(collection(App.db, SHARED_COLLECTIONS.rawMaterials), formValues); Swal.fire('تم!', 'تمت إضافة المادة الخام بنجاح.', 'success'); } catch (e) { console.error("Error adding document: ", e); Swal.fire('خطأ', 'لم نتمكن من إضافة المادة.', 'error'); } } },
                async edit(id) { const item = App.state.rawMaterials.find(i => i.id === id); if (!item) return; const { value: formValues } = await Swal.fire({ title: 'تعديل مادة خام', html: `<input id="swal-name" class="swal2-input" placeholder="اسم المادة" value="${item.name}" required><input id="swal-supplier" class="swal2-input" placeholder="المورد (اختياري)" value="${item.supplier || ''}"><input id="swال-unit" class="swal2-input" placeholder="وحدة القياس" value="${item.unit}"><input id="swal-stock" type="number" class="swal2-input" placeholder="الكمية الحالية" value="${item.stock}" min="0"><input id="swal-threshold" type="number" class="swal2-input" placeholder="حد التنبيه" value="${item.threshold}" min="0">`, focusConfirm: false, confirmButtonText: 'حفظ التعديلات', cancelButtonText: 'إلغاء', showCancelButton: true, preConfirm: () => { const name = document.getElementById('swal-name').value; if (!name) { Swal.showValidationMessage(`اسم المادة مطلوب`); return false; } return { name: name, supplier: document.getElementById('swal-supplier').value, unit: document.getElementById('swal-unit').value, stock: parseFloat(document.getElementById('swal-stock').value) || 0, threshold: parseFloat(document.getElementById('swal-threshold').value) || 0, } } }); if (formValues) { try { await setDoc(doc(App.db, SHARED_COLLECTIONS.rawMaterials, id), formValues, { merge: true }); Swal.fire('تم!', 'تم تحديث المادة الخام بنجاح.', 'success'); } catch (e) { console.error("Error updating document: ", e); Swal.fire('خطأ', 'لم نتمكن من تحديث المادة.', 'error'); } } },
                delete(id) { Swal.fire({ title: 'هل أنت متأكد؟', text: "سيتم حذف هذه المادة الخام نهائيًا!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'نعم، احذفه!', cancelButtonText: 'إلغاء' }).then(async (result) => { if (result.isConfirmed) { try { await deleteDoc(doc(App.db, SHARED_COLLECTIONS.rawMaterials, id)); Swal.fire('تم الحذف!', 'تم حذف المادة الخام.', 'success'); } catch (e) { console.error("Error deleting document: ", e); Swal.fire('خطأ', 'لم نتمكن من حذف المادة.', 'error'); } } }); }
            },
            spareParts: {
                 async add() { const { value: formValues } = await Swal.fire({ title: 'إضافة قطعة غيار جديدة', html: `<input id="swal-name" class="swal2-input" placeholder="اسم القطعة" required><input id="swal-supplier" class="swal2-input" placeholder="المورد (اختياري)"><input id="swal-unit" class="swal2-input" placeholder="وحدة القياس"><input id="swal-stock" type="number" class="swal2-input" placeholder="الكمية الأولية" value="0" min="0"><input id="swal-threshold" type="number" class="swal2-input" placeholder="حد التنبيه" value="0" min="0">`, focusConfirm: false, confirmButtonText: 'إضافة', cancelButtonText: 'إلغاء', showCancelButton: true, preConfirm: () => { const name = document.getElementById('swal-name').value; if (!name) { Swal.showValidationMessage(`اسم القطعة مطلوب`); return false; } return { name: name, supplier: document.getElementById('swal-supplier').value, unit: document.getElementById('swal-unit').value, stock: parseFloat(document.getElementById('swal-stock').value) || 0, threshold: parseFloat(document.getElementById('swal-threshold').value) || 0, } } }); if (formValues) { try { await addDoc(collection(App.db, SHARED_COLLECTIONS.spareParts), formValues); Swal.fire('تم!', 'تمت إضافة قطعة الغيار بنجاح.', 'success'); } catch (e) { Swal.fire('خطأ', 'لم نتمكن من إضافة القطعة.', 'error'); } } },
                 async edit(id) { const item = App.state.spareParts.find(i => i.id === id); if (!item) return; const { value: formValues } = await Swal.fire({ title: 'تعديل قطعة غيار', html: `<input id="swal-name" class="swal2-input" placeholder="اسم القطعة" value="${item.name}" required><input id="swal-supplier" class="swal2-input" placeholder="المورد (اختياري)" value="${item.supplier || ''}"><input id="swal-unit" class="swal2-input" placeholder="وحدة القياس" value="${item.unit}"><input id="swal-stock" type="number" class="swal2-input" placeholder="الكمية الحالية" value="${item.stock}" min="0"><input id="swal-threshold" type="number" class="swal2-input" placeholder="حد التنبيه" value="${item.threshold}" min="0">`, focusConfirm: false, confirmButtonText: 'حفظ التعديلات', cancelButtonText: 'إلغاء', showCancelButton: true, preConfirm: () => { const name = document.getElementById('swal-name').value; if (!name) { Swal.showValidationMessage(`اسم القطعة مطلوب`); return false; } return { name: name, supplier: document.getElementById('swal-supplier').value, unit: document.getElementById('swal-unit').value, stock: parseFloat(document.getElementById('swal-stock').value) || 0, threshold: parseFloat(document.getElementById('swal-threshold').value) || 0, } } }); if (formValues) { try { await setDoc(doc(App.db, SHARED_COLLECTIONS.spareParts, id), formValues, { merge: true }); Swal.fire('تم!', 'تم تحديث قطعة الغيار بنجاح.', 'success'); } catch (e) { Swal.fire('خطأ', 'لم نتمكن من تحديث القطعة.', 'error'); } } },
                 delete(id) { Swal.fire({ title: 'هل أنت متأكد؟', text: "سيتم حذف قطعة الغيار هذه نهائيًا!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'نعم، احذفه!', cancelButtonText: 'إلغاء' }).then(async (result) => { if (result.isConfirmed) { try { await deleteDoc(doc(App.db, SHARED_COLLECTIONS.spareParts, id)); Swal.fire('تم الحذف!', 'تم حذف قطعة الغيار.', 'success'); } catch (e) { Swal.fire('خطأ', 'لم نتمكن من حذف القطعة.', 'error'); } } }); }
            },
            products: {
                async add() { const { value: formValues } = await Swal.fire({ title: 'إضافة منتج جاهز جديد', html: `<input id="swal-name" class="swal2-input" placeholder="اسم المنتج" required><input id="swal-unit" class="swal2-input" placeholder="وحدة القياس (مثال: كرتونة, عبوة)"><input id="swal-stock" type="number" class="swal2-input" placeholder="الكمية الأولية" value="0" min="0">`, focusConfirm: false, confirmButtonText: 'إضافة', cancelButtonText: 'إلغاء', showCancelButton: true, preConfirm: () => { const name = document.getElementById('swal-name').value; if (!name) { Swal.showValidationMessage(`اسم المنتج مطلوب`); return false; } return { name: name, unit: document.getElementById('swal-unit').value, stock: parseFloat(document.getElementById('swal-stock').value) || 0, } } }); if (formValues) { try { await addDoc(collection(App.db, SHARED_COLLECTIONS.finishedProducts), { bom: [], ...formValues }); Swal.fire('تم!', 'تمت إضافة المنتج بنجاح.', 'success'); } catch (e) { Swal.fire('خطأ', 'لم نتمكن من إضافة المنتج.', 'error'); } } },
                async edit(id) { const item = App.state.finishedProducts.find(i => i.id === id); if (!item) return; const { value: formValues } = await Swal.fire({ title: 'تعديل منتج جاهز', html: `<input id="swal-name" class="swal2-input" placeholder="اسم المنتج" value="${item.name}" required><input id="swal-unit" class="swal2-input" placeholder="وحدة القياس" value="${item.unit}"><input id="swal-stock" type="number" class="swal2-input" placeholder="الكمية الحالية" value="${item.stock}" min="0">`, focusConfirm: false, confirmButtonText: 'حفظ التعديلات', cancelButtonText: 'إلغاء', showCancelButton: true, preConfirm: () => { const name = document.getElementById('swal-name').value; if (!name) { Swal.showValidationMessage(`اسم المنتج مطلوب`); return false; } return { name: name, unit: document.getElementById('swal-unit').value, stock: parseFloat(document.getElementById('swal-stock').value) || 0, } } }); if (formValues) { try { await setDoc(doc(App.db, SHARED_COLLECTIONS.finishedProducts, id), formValues, { merge: true }); Swal.fire('تم!', 'تم تحديث المنتج بنجاح.', 'success'); } catch (e) { Swal.fire('خطأ', 'لم نتمكن من تحديث المنتج.', 'error'); } } },
                delete(id) { Swal.fire({ title: 'هل أنت متأكد؟', text: "سيتم حذف هذا المنتج نهائيًا!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'نعم، احذفه!', cancelButtonText: 'إلغاء' }).then(async (result) => { if (result.isConfirmed) { try { await deleteDoc(doc(App.db, SHARED_COLLECTIONS.finishedProducts, id)); Swal.fire('تم الحذف!', 'تم حذف المنتج.', 'success'); } catch (e) { Swal.fire('خطأ', 'لم نتمكن من حذف المنتج.', 'error'); } } }); },
                async addProduction(productId) { const product = App.state.finishedProducts.find(p => p.id === productId); if (!product) return; if (!product.bom || product.bom.length === 0) { Swal.fire('خطأ', 'لا يمكن الإنتاج. لم يتم تعريف مكونات (BOM) لهذا المنتج.', 'error'); return; } const { value: qty } = await Swal.fire({ title: `إنتاج ${product.name}`, input: 'number', inputLabel: `أدخل الكمية المراد إنتاجها`, inputPlaceholder: 'مثال: 50', showCancelButton: true, confirmButtonText: 'بدء الإنتاج', cancelButtonText: 'إلغاء', inputValidator: (value) => { if (!value || value <= 0) { return 'الرجاء إدخال كمية صحيحة!' } } }); if (qty) { const quantity = parseFloat(qty); let canProduce = true; const rawMaterialsUsed = []; for (const item of product.bom) { const rawMaterial = App.state.rawMaterials.find(rm => rm.id === item.rawMaterialId); const required = item.quantity * quantity; if (!rawMaterial || rawMaterial.stock < required) { canProduce = false; Swal.fire('نقص في المخزون!', `لا توجد كمية كافية من "${rawMaterial ? rawMaterial.name : 'مادة محذوفة'}". المطلوب: ${required}, المتاح: ${rawMaterial ? rawMaterial.stock : 0}.`, 'warning'); break; } rawMaterialsUsed.push({ rawMaterialId: item.rawMaterialId, quantity: required, rawMaterialName: rawMaterial.name }); } if (canProduce) { try { const batch = writeBatch(App.db); rawMaterialsUsed.forEach(used => { const rmRef = doc(App.db, SHARED_COLLECTIONS.rawMaterials, used.rawMaterialId); const rawMaterial = App.state.rawMaterials.find(rm => rm.id === used.rawMaterialId); batch.update(rmRef, { stock: rawMaterial.stock - used.quantity }); }); const productRef = doc(App.db, SHARED_COLLECTIONS.finishedProducts, productId); batch.update(productRef, { stock: product.stock + quantity }); const transColRef = collection(App.db, SHARED_COLLECTIONS.transactions); batch.set(doc(transColRef), { id: `t_${Date.now()}`, date: new Date().toISOString(), type: 'production', itemId: productId, itemName: product.name, quantity: quantity, rawMaterialsUsed: rawMaterialsUsed }); await batch.commit(); Swal.fire('تم الإنتاج!', `تمت إضافة ${quantity} من ${product.name}.`, 'success'); } catch (e) { console.error("Error committing production batch: ", e); Swal.fire('خطأ', 'حدث خطأ أثناء تسجيل الإنتاج.', 'error'); } } } }
            },
            sales: {
                async record() { const productId = document.getElementById('salesProductSelect').value; const quantity = parseFloat(document.getElementById('salesQty').value); if (!productId || !quantity || quantity <= 0) { Swal.fire('خطأ', 'الرجاء اختيار منتج وإدخال كمية صحيحة.', 'error'); return; } const product = App.state.finishedProducts.find(p => p.id === productId); if (!product || product.stock < quantity) { Swal.fire('خطأ في المخزون', `الكمية المطلوبة (${quantity}) أكبر من المتاح (${product ? product.stock : 0}).`, 'error'); return; } try { const batch = writeBatch(App.db); const productRef = doc(App.db, SHARED_COLLECTIONS.finishedProducts, productId); batch.update(productRef, { stock: product.stock - quantity }); const transColRef = collection(App.db, SHARED_COLLECTIONS.transactions); batch.set(doc(transColRef), { id: `t_${Date.now()}`, date: new Date().toISOString(), type: 'sale', itemId: productId, itemName: product.name, quantity: quantity }); await batch.commit(); document.getElementById('salesQty').value = ''; document.getElementById('salesProductSelect').value = ''; Swal.fire('تم البيع!', `تم خصم ${quantity} من ${product.name}.`, 'success'); } catch (e) { console.error("Error committing sale batch: ", e); Swal.fire('خطأ', 'حدث خطأ أثناء تسجيل البيع.', 'error'); } }
            },
            bom: {
                showBOMForProduct(productId) { const bomDetailsDiv = document.getElementById('bomDetails'); if (!productId) { bomDetailsDiv.classList.add('hidden'); return; } const product = App.state.finishedProducts.find(p => p.id === productId); document.getElementById('bomProductName').textContent = product.name; App.render.bomList(productId); App.render.bomRawMaterialSelect(); bomDetailsDiv.classList.remove('hidden'); },
                async add() { const productId = document.getElementById('bomProductSelect').value; const rawMaterialId = document.getElementById('bomRawMaterialSelect').value; const quantity = parseFloat(document.getElementById('bomRawMaterialQty').value); if (!productId || !rawMaterialId || !quantity || quantity <= 0) { Swal.fire('خطأ', 'الرجاء اختيار منتج ومادة خام وإدخال كمية صحيحة.', 'error'); return; } const product = App.state.finishedProducts.find(p => p.id === productId); const productRef = doc(App.db, SHARED_COLLECTIONS.finishedProducts, productId); let newBom = product.bom ? [...product.bom] : []; const existingItemIndex = newBom.findIndex(item => item.rawMaterialId === rawMaterialId); if(existingItemIndex > -1) { newBom[existingItemIndex].quantity = quantity; } else { newBom.push({ rawMaterialId, quantity }); } try { await updateDoc(productRef, { bom: newBom }); document.getElementById('bomRawMaterialQty').value = ''; Swal.fire('تم!', 'تمت إضافة/تحديث المادة للمكونات بنجاح.', 'success'); } catch (e) { Swal.fire('خطأ', 'لم نتمكن من تحديث المكونات.', 'error'); } },
                async delete(productId, rawMaterialId) { const product = App.state.finishedProducts.find(p => p.id === productId); if (!product || !product.bom) return; const productRef = doc(App.db, SHARED_COLLECTIONS.finishedProducts, productId); const newBom = product.bom.filter(item => item.rawMaterialId !== rawMaterialId); try { await updateDoc(productRef, { bom: newBom }); } catch (e) { Swal.fire('خطأ', 'لم نتمكن من حذف المكون.', 'error'); } }
            },
            waste: {
                async record() { const type = document.getElementById('wasteTypeSelect').value; const itemId = document.getElementById('wasteItemSelect').value; const quantity = parseFloat(document.getElementById('wasteQty').value); if(!itemId || !quantity || quantity <= 0) { Swal.fire('خطأ', 'الرجاء اختيار صنف وإدخال كمية صحيحة.', 'error'); return; } let items, collectionNameFirebase, item, itemName, typeAr; if(type === 'raw') { items = App.state.rawMaterials; collectionNameFirebase = SHARED_COLLECTIONS.rawMaterials; typeAr = 'مادة خام'; } else if(type === 'spare') { items = App.state.spareParts; collectionNameFirebase = SHARED_COLLECTIONS.spareParts; typeAr = 'قطعة غيار'; } else { items = App.state.finishedProducts; collectionNameFirebase = SHARED_COLLECTIONS.finishedProducts; typeAr = 'منتج جاهز'; } item = items.find(i => i.id === itemId); itemName = item ? item.name : 'صنف محذوف'; if (!item || item.stock < quantity) { Swal.fire('خطأ', `الكمية المفقودة أكبر من الكمية المتاحة في المخزون (${item.stock}).`, 'error'); return; } try { const batch = writeBatch(App.db); const itemRef = doc(App.db, collectionNameFirebase, itemId); batch.update(itemRef, { stock: item.stock - quantity }); const wasteColRef = collection(App.db, SHARED_COLLECTIONS.wasteLog); batch.set(doc(wasteColRef), { id: `w_${Date.now()}`, date: new Date().toISOString(), type, typeAr, itemId, itemName, quantity }); await batch.commit(); document.getElementById('wasteQty').value = ''; Swal.fire('تم التسجيل!', 'تم تسجيل الهدر وخصمه من المخزون.', 'success'); } catch (e) { console.error("Error committing waste batch: ", e); Swal.fire('خطأ', 'حدث خطأ أثناء تسجيل الهدر.', 'error'); } }
            },
            
            // --- (((( هنا تم تعديل دالة التقارير لإضافة data-label )))) ---
            reports: {
                 toggleDateInputs() { const type = document.getElementById('reportType').value; const dateInput = document.getElementById('reportDate'); const monthInput = document.getElementById('reportMonth'); if (type === 'daily') { dateInput.classList.remove('hidden'); dateInput.previousElementSibling.classList.remove('hidden'); monthInput.classList.add('hidden'); monthInput.previousElementSibling.classList.add('hidden'); } else { dateInput.classList.add('hidden'); dateInput.previousElementSibling.classList.add('hidden'); monthInput.classList.remove('hidden'); monthInput.previousElementSibling.classList.remove('hidden'); } },
                 generate() { 
                    const type = document.getElementById('reportType').value; const dateVal = document.getElementById('reportDate').value; const monthVal = document.getElementById('reportMonth').value; const outputDiv = document.getElementById('textReportOutput'); 
                    if ((type === 'daily' && !dateVal) || (type === 'monthly' && !monthVal)) { outputDiv.innerHTML = `<p style="text-align: center; color: var(--text-secondary);">الرجاء اختيار تاريخ صالح لعرض التقرير.</p>`; return; } 
                    let startDate, endDate; 
                    if (type === 'daily') { startDate = new Date(dateVal); startDate.setHours(0, 0, 0, 0); endDate = new Date(dateVal); endDate.setHours(23, 59, 59, 999); } 
                    else { const [year, month] = monthVal.split('-'); startDate = new Date(year, month - 1, 1); endDate = new Date(year, month, 0, 23, 59, 59, 999); } 
                    const transactionsInPeriod = App.state.transactions.filter(t => { const tDate = new Date(t.date); return tDate >= startDate && tDate <= endDate; }); 
                    const wasteInPeriod = App.state.wasteLog.filter(w => { const wDate = new Date(w.date); return wDate >= startDate && wDate <= endDate; }); 
                    
                    let reportHTML = `<h3>تقرير ${type === 'daily' ? 'يومي' : 'شهري'} للفترة من ${startDate.toLocaleDateString('ar-EG')} إلى ${endDate.toLocaleDateString('ar-EG')}</h3>`; 
                    
                    let productsSection = `<div class="report-section"><h4>1. قسم الإنتاج الجاهز والمبيعات</h4><table class="data-table"><thead><tr><th>المنتج</th><th>رصيد افتتاحي</th><th>إنتاج (+)</th><th>مبيعات (-)</th><th>هدر (-)</th><th>رصيد ختامي</th></tr></thead><tbody>`; 
                    App.state.finishedProducts.forEach(product => { 
                        const productions = transactionsInPeriod.filter(t => t.type === 'production' && t.itemId === product.id); 
                        const sales = transactionsInPeriod.filter(t => t.type === 'sale' && t.itemId === product.id); 
                        const waste = wasteInPeriod.filter(w => w.type === 'product' && w.itemId === product.id); 
                        const totalProduction = productions.reduce((sum, t) => sum + t.quantity, 0); 
                        const totalSales = sales.reduce((sum, t) => sum + t.quantity, 0); 
                        const totalWaste = waste.reduce((sum, w) => sum + w.quantity, 0); 
                        const closingBalance = product.stock; 
                        const openingBalance = closingBalance - totalProduction + totalSales + totalWaste; 
                        productsSection += `<tr>
                                                <td data-label="المنتج">${product.name} (${product.unit})</td>
                                                <td data-label="رصيد افتتاحي">${openingBalance.toFixed(2)}</td>
                                                <td data-label="إنتاج (+)">${totalProduction.toFixed(2)}</td>
                                                <td data-label="مبيعات (-)">${totalSales.toFixed(2)}</td>
                                                <td data-label="هدر (-)">${totalWaste.toFixed(2)}</td>
                                                <td data-label="رصيد ختامي"><strong>${closingBalance.toFixed(2)}</strong></td>
                                            </tr>`; 
                    }); 
                    productsSection += `</tbody></table></div>`; 
                    reportHTML += productsSection; 
                    
                    let rawMaterialsSection = `<div class="report-section"><h4>2. قسم المواد الخام</h4><table class="data-table"><thead><tr><th>المادة الخام</th><th>رصيد افتتاحي</th><th>مستخدم (-)</th><th>هدر (-)</th><th>رصيد ختامي</th></tr></thead><tbody>`; 
                    App.state.rawMaterials.forEach(rm => { 
                        let totalUsed = 0; 
                        transactionsInPeriod.forEach(t => { if (t.type === 'production' && t.rawMaterialsUsed) { const used = t.rawMaterialsUsed.find(usedRm => usedRm.rawMaterialId === rm.id); if (used) totalUsed += used.quantity; } }); 
                        const waste = wasteInPeriod.filter(w => w.type === 'raw' && w.itemId === rm.id); 
                        const totalWaste = waste.reduce((sum, w) => sum + w.quantity, 0); 
                        const closingBalance = rm.stock; 
                        const openingBalance = closingBalance + totalUsed + totalWaste; 
                        rawMaterialsSection += `<tr>
                                                    <td data-label="المادة الخام">${rm.name} (${rm.unit})</td>
                                                    <td data-label="رصيد افتتاحي">${openingBalance.toFixed(2)}</td>
                                                    <td data-label="مستخدم (-)">${totalUsed.toFixed(2)}</td>
                                                    <td data-label="هدر (-)">${totalWaste.toFixed(2)}</td>
                                                    <td data-label="رصيد ختامي"><strong>${closingBalance.toFixed(2)}</strong></td>
                                                </tr>`; 
                    }); 
                    rawMaterialsSection += `</tbody></table></div>`; 
                    reportHTML += rawMaterialsSection; 
                    
                    let sparePartsSection = `<div class="report-section"><h4>3. قسم قطع الغيار</h4><table class="data-table"><thead><tr><th>قطعة الغيار</th><th>رصيد افتتاحي</th><th>هدر (-)</th><th>رصيد ختامي</th></tr></thead><tbody>`; 
                    App.state.spareParts.forEach(sp => { 
                        const waste = wasteInPeriod.filter(w => w.type === 'spare' && w.itemId === sp.id); 
                        const totalWaste = waste.reduce((sum, w) => sum + w.quantity, 0); 
                        const closingBalance = sp.stock; 
                        const openingBalance = closingBalance + totalWaste; 
                        sparePartsSection += `<tr>
                                                <td data-label="قطعة الغيار">${sp.name} (${sp.unit})</td>
                                                <td data-label="رصيد افتتاحي">${openingBalance.toFixed(2)}</td>
                                                <td data-label="هدر (-)">${totalWaste.toFixed(2)}</td>
                                                <td data-label="رصيد ختامي"><strong>${closingBalance.toFixed(2)}</strong></td>
                                              </tr>`; 
                    }); 
                    sparePartsSection += `</tbody></table></div>`; 
                    reportHTML += sparePartsSection; 
                    
                    outputDiv.innerHTML = reportHTML; 
                }
            },
            // --- (((( نهاية تعديل دالة التقارير )))) ---

             settings: {
                 exportData() { const dataStr = JSON.stringify(App.state, null, 2); const dataBlob = new Blob([dataStr], {type: "application/json"}); const dataUrl = URL.createObjectURL(dataBlob); const exportFileDefaultName = `saha_inventory_backup_${new Date().toISOString().slice(0,10)}.json`; const linkElement = document.createElement('a'); linkElement.href = dataUrl; linkElement.download = exportFileDefaultName; document.body.appendChild(linkElement); linkElement.click(); document.body.removeChild(linkElement); URL.revokeObjectURL(dataUrl); Swal.fire('تم!', 'جاري تحميل ملف النسخة الاحتياطية.', 'success'); },
                 importData(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const newState = JSON.parse(e.target.result); if ('rawMaterials' in newState && 'finishedProducts' in newState) { Swal.fire({ title: 'تأكيد الاستيراد', text: "سيتم استبدال جميع البيانات الحالية بالبيانات الموجودة في الملف. هل أنت متأكد؟ (هذا لا يمكن التراجع عنه!)", icon: 'warning', showCancelButton: true, confirmButtonText: 'نعم، استورد البيانات!', cancelButtonText: 'إلغاء' }).then(async (result) => { if (result.isConfirmed) { Swal.fire({ title: 'جاري الاستيراد...', html: 'الرجاء الانتظار، قد يستغرق هذا بعض الوقت...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } }); const batch = writeBatch(App.db); for (const key in SHARED_COLLECTIONS) { const colName = SHARED_COLLECTIONS[key]; const querySnapshot = await getDocs(collection(App.db, colName)); querySnapshot.forEach(doc => batch.delete(doc.ref)); } await batch.commit(); const importBatch = writeBatch(App.db); Object.keys(SHARED_COLLECTIONS).forEach(stateKey => { const collectionNameFirebase = SHARED_COLLECTIONS[stateKey]; if(newState[stateKey]) { newState[stateKey].forEach(item => { const { id, ...data } = item; const docRef = id ? doc(App.db, collectionNameFirebase, id) : doc(collection(App.db, collectionNameFirebase)); importBatch.set(docRef, data); }); } }); await importBatch.commit(); Swal.fire('نجاح!', 'تم استيراد البيانات بنجاح.', 'success'); } }); } else { throw new Error('Invalid file format'); } } catch (error) { Swal.fire('خطأ', 'الملف غير صالح أو تالف.', 'error'); } finally { event.target.value = ''; } }; reader.readAsText(file); },
                 async deleteAllData() { Swal.fire({ title: 'هل أنت متأكد تمامًا؟', html: `هذا الإجراء سيحذف <b>كل شيء</b> نهائيًا من قاعدة البيانات المشتركة.<br>اكتب "حذف" للتأكيد.`, icon: 'error', input: 'text', inputAttributes: { autocapitalize: 'off' }, showCancelButton: true, confirmButtonText: 'تأكيد الحذف', cancelButtonText: 'إلغاء', preConfirm: (value) => { if (value !== 'حذف') { Swal.showValidationMessage('الرجاء كتابة "حذف" بشكل صحيح للتأكيد.'); } } }).then(async (result) => { if (result.isConfirmed) { Swal.fire({ title: 'جاري الحذف...', html: 'الرجاء الانتظار...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } }); const batch = writeBatch(App.db); for (const key in SHARED_COLLECTIONS) { const colName = SHARED_COLLECTIONS[key]; const querySnapshot = await getDocs(collection(App.db, colName)); querySnapshot.forEach(doc => batch.delete(doc.ref)); } await batch.commit(); Swal.fire('تم الحذف!', 'تم حذف جميع البيانات بنجاح.', 'success'); } }); },
                 async printReport() { const { jsPDF } = window.jspdf; const { autoTable } = window.jspdf.plugin.autotable; const reportContent = document.getElementById('reportContent'); const originalBackgroundColor = reportContent.style.backgroundColor; reportContent.style.backgroundColor = 'white'; const canvas = await html2canvas(reportContent, { scale: 2, useCORS: true }); reportContent.style.backgroundColor = originalBackgroundColor; const imgData = canvas.toDataURL('image/png'); const pdfWidth = 595.28; // A4 width in points
                 const pdfHeight = (canvas.height * pdfWidth) / canvas.width; const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: [pdfWidth, pdfHeight] }); pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight); pdf.save(`report_${new Date().toISOString().slice(0,10)}.pdf`); }
            }
        };

        // --- Auth Handling (Modified for Anonymous Auth) ---
        try {
            console.log("Initializing Firebase...");
            const firebaseApp = initializeApp(firebaseConfig);
            const auth = getAuth(firebaseApp);
            const db = getFirestore(firebaseApp);
            
            enableIndexedDbPersistence(db)
              .catch((err) => {
                  if (err.code == 'failed-precondition') { console.warn('Firebase persistence failed: multiple tabs open.'); } 
                  else if (err.code == 'unimplemented') { console.error('Firebase persistence is not available in this browser.'); }
              });

            
            onAuthStateChanged(auth, async function(user) {
              try {
                if (!user) {
                  console.log("No user, signing in anonymously...");
                  await signInAnonymously(auth);
                  return; // wait for next auth state change
                }
                
                console.log("Anonymous user signed in:", user.uid);
                
                try {
                  // نهيئة التطبيق أولاً
                  await App.init(db, user, auth);
                } catch (e) {
                  console.error("App.init error:", e);
                }
                
                // --- الإصلاح الرئيسي (بقى كما هو) ---
                var loaderEl = document.querySelector('#loading-screen'); 
                if (loaderEl) { 
                    loaderEl.classList.add('hidden'); 
                }
                
                var mainEl = document.querySelector('#app-container'); 
                if (mainEl) { 
                    mainEl.classList.remove('hidden'); 
                }
                // --- نهاية الإصلاح ---

              } catch (error) {
                console.error("Auth error:", error);
                
                var loaderEl2 = document.querySelector('#loading-screen'); 
                if (loaderEl2) { loaderEl2.classList.add('hidden'); }

                Swal.fire('خطأ في المصادقة', 'فشل تسجيل الدخول المجهول. تأكد من تفعيله في Firebase Console.', 'error');
              }
            });

        } catch (e) {
            console.error("Firebase initialization failed:", e);
             document.getElementById('loading-screen').innerHTML = '<h1>فشل تهيئة Firebase.</h1>';
        }
    </script>
</body>
</html>

